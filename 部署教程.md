# è…¾è®¯äº‘å°ç¨‹åºå…¨æ ˆé¡¹ç›®éƒ¨ç½²æ•™ç¨‹

## ç›®å½•

- [è…¾è®¯äº‘å°ç¨‹åºå…¨æ ˆé¡¹ç›®éƒ¨ç½²æ•™ç¨‹](#è…¾è®¯äº‘å°ç¨‹åºå…¨æ ˆé¡¹ç›®éƒ¨ç½²æ•™ç¨‹)
  - [ç›®å½•](#ç›®å½•)
  - [æœåŠ¡å™¨å‡†å¤‡ä¸ç¯å¢ƒé…ç½®](#æœåŠ¡å™¨å‡†å¤‡ä¸ç¯å¢ƒé…ç½®)
    - [è¿æ¥æœåŠ¡å™¨](#è¿æ¥æœåŠ¡å™¨)
    - [åˆ›å»ºéƒ¨ç½²ç”¨æˆ·](#åˆ›å»ºéƒ¨ç½²ç”¨æˆ·)
    - [åŸºç¡€ç¯å¢ƒé…ç½®](#åŸºç¡€ç¯å¢ƒé…ç½®)
    - [å®‰è£… Python ç¯å¢ƒ](#å®‰è£…-python-ç¯å¢ƒ)
    - [å®‰è£…æ•°æ®åº“](#å®‰è£…æ•°æ®åº“)
    - [å®‰è£… Nginx](#å®‰è£…-nginx)
    - [é…ç½®é˜²ç«å¢™](#é…ç½®é˜²ç«å¢™)
  - [FastAPI åç«¯éƒ¨ç½²](#fastapi-åç«¯éƒ¨ç½²)
    - [ä»£ç éƒ¨ç½²](#ä»£ç éƒ¨ç½²)
    - [è™šæ‹Ÿç¯å¢ƒé…ç½®](#è™šæ‹Ÿç¯å¢ƒé…ç½®)
    - [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
    - [æ•°æ®åº“åˆå§‹åŒ–](#æ•°æ®åº“åˆå§‹åŒ–)
    - [åº”ç”¨å¯åŠ¨æ–¹æ¡ˆ](#åº”ç”¨å¯åŠ¨æ–¹æ¡ˆ)
      - [æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ uvicorn ç›´æ¥å¯åŠ¨ï¼ˆç®€å•ä½†é€‚åˆå¼€å‘å’Œæµ‹è¯•ï¼‰](#æ–¹æ¡ˆ-1ä½¿ç”¨-uvicorn-ç›´æ¥å¯åŠ¨ç®€å•ä½†é€‚åˆå¼€å‘å’Œæµ‹è¯•)
      - [æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Gunicorn + Supervisorï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰](#æ–¹æ¡ˆ-2ä½¿ç”¨-gunicorn--supervisoræ¨èç”Ÿäº§ç¯å¢ƒ)
    - [åå‘ä»£ç†é…ç½®](#åå‘ä»£ç†é…ç½®)
  - [uni-app å°ç¨‹åºå‰ç«¯å‘å¸ƒ](#uni-app-å°ç¨‹åºå‰ç«¯å‘å¸ƒ)
    - [é…ç½®é¡¹ç›®](#é…ç½®é¡¹ç›®)
    - [ç¼–è¯‘ä¸æµ‹è¯•](#ç¼–è¯‘ä¸æµ‹è¯•)
    - [å‘å¸ƒä¸å®¡æ ¸](#å‘å¸ƒä¸å®¡æ ¸)
  - [åŸŸåé…ç½®ä¸ SSL è¯ä¹¦](#åŸŸåé…ç½®ä¸-ssl-è¯ä¹¦)
    - [åŸŸåè§„åˆ’](#åŸŸåè§„åˆ’)
    - [åŸŸåè§£æ](#åŸŸåè§£æ)
    - [åŸŸåå¤‡æ¡ˆ](#åŸŸåå¤‡æ¡ˆ)
    - [SSL è¯ä¹¦é…ç½®](#ssl-è¯ä¹¦é…ç½®)
  - [æ—¥å¿—ç®¡ç†ä¸ç›‘æ§](#æ—¥å¿—ç®¡ç†ä¸ç›‘æ§)
    - [æ—¥å¿—é…ç½®](#æ—¥å¿—é…ç½®)
    - [æ—¥å¿—è½®è½¬](#æ—¥å¿—è½®è½¬)
    - [ç›‘æ§ä¸æŠ¥è­¦](#ç›‘æ§ä¸æŠ¥è­¦)
  - [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)
    - [æœåŠ¡å™¨é—®é¢˜](#æœåŠ¡å™¨é—®é¢˜)
    - [ç½‘ç»œé—®é¢˜](#ç½‘ç»œé—®é¢˜)
    - [åº”ç”¨é—®é¢˜](#åº”ç”¨é—®é¢˜)
    - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
  - [ç³»ç»Ÿå‡çº§æ–¹æ¡ˆ](#ç³»ç»Ÿå‡çº§æ–¹æ¡ˆ)
    - [åç«¯å‡çº§æµç¨‹](#åç«¯å‡çº§æµç¨‹)
    - [å‰ç«¯å‡çº§æµç¨‹](#å‰ç«¯å‡çº§æµç¨‹)
    - [æ•°æ®åº“å‡çº§](#æ•°æ®åº“å‡çº§)
    - [ç‰ˆæœ¬å›æ»šæ–¹æ¡ˆ](#ç‰ˆæœ¬å›æ»šæ–¹æ¡ˆ)
    - [è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸æŒç»­é›†æˆ](#è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸æŒç»­é›†æˆ)

## æœåŠ¡å™¨å‡†å¤‡ä¸ç¯å¢ƒé…ç½®

### è¿æ¥æœåŠ¡å™¨

1. **Windows ç”¨æˆ·**ï¼šä½¿ç”¨ PuTTY æˆ–å…¶ä»– SSH å®¢æˆ·ç«¯

   ```
   ä¸»æœºï¼šæœåŠ¡å™¨å…¬ç½‘IP
   ç«¯å£ï¼š22
   ç”¨æˆ·åï¼šé»˜è®¤ä¸ºrootï¼ˆä¹Ÿå¯èƒ½æ˜¯ubuntuæˆ–å…¶ä»–ï¼‰
   å¯†ç ï¼šè…¾è®¯äº‘æ§åˆ¶å°è®¾ç½®çš„å¯†ç 
   ```

2. **Mac/Linux ç”¨æˆ·**ï¼šä½¿ç”¨ç»ˆç«¯
   ```bash
   ssh root@æœåŠ¡å™¨å…¬ç½‘IP
   ```

### åˆ›å»ºéƒ¨ç½²ç”¨æˆ·

> **ğŸ”’ å®‰å…¨æç¤º**: ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œåº”ç”¨æ˜¯æé«˜å®‰å…¨æ€§çš„å…³é”®æ­¥éª¤

```bash
# ç™»å½•åˆ°æœåŠ¡å™¨åï¼Œåˆ›å»ºæ–°ç”¨æˆ·
adduser deploy

# å°†ç”¨æˆ·æ·»åŠ åˆ°sudoç»„(åœ¨éœ€è¦æ—¶å¯ä»¥è·å–ç®¡ç†æƒé™)
usermod -aG sudo deploy

# è®¾ç½®SSHå¯†é’¥è®¤è¯(å¯é€‰ä½†æ¨è)
mkdir -p /home/deploy/.ssh
cp ~/.ssh/authorized_keys /home/deploy/.ssh/ # å¦‚æœä½ å·²ä½¿ç”¨å¯†é’¥ç™»å½•root
chown -R deploy:deploy /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
chmod 600 /home/deploy/.ssh/authorized_keys

# åˆ‡æ¢åˆ°æ–°ç”¨æˆ·
su - deploy

# éªŒè¯èº«ä»½
whoami
```

ç„¶ååˆ›å»ºå¹¶è®¾ç½®åº”ç”¨ç›®å½•æƒé™ï¼š

```bash
# ä»¥rootç”¨æˆ·åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www/ai_assistant

# å°†ç›®å½•æ‰€æœ‰æƒç»™deployç”¨æˆ·
sudo chown -R deploy:deploy /var/www/ai_assistant

# è®¾ç½®åˆé€‚çš„æƒé™
sudo chmod -R 755 /var/www/ai_assistant
```

æ—¥å¿—ç›®å½•æƒé™è®¾ç½®:

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/gunicorn
sudo mkdir -p /var/log/app

# è®¾ç½®æƒé™
sudo chown -R deploy:deploy /var/log/gunicorn
sudo chown -R deploy:deploy /var/log/app
```

### åŸºç¡€ç¯å¢ƒé…ç½®

ä»¥ä¸‹å‘½ä»¤æœ€å¥½ä»¥ root ç”¨æˆ·æ‰§è¡Œï¼Œæˆ–åœ¨å‘½ä»¤å‰åŠ  `sudo`:

```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
apt update

# å‡çº§å·²å®‰è£…çš„è½¯ä»¶åŒ…
apt upgrade -y

# å®‰è£…å¸¸ç”¨å·¥å…·
apt install -y curl git vim wget build-essential

# é…ç½®æœåŠ¡å™¨æ—¶åŒº
timedatectl set-timezone Asia/Shanghai
```

### å®‰è£… Python ç¯å¢ƒ

```bash
# å®‰è£…Python
apt install -y python3 python3-pip python3-venv

# æ£€æŸ¥Pythonç‰ˆæœ¬ (ç¡®ä¿ä½¿ç”¨ 3.9+ ç‰ˆæœ¬)
python3 --version

# å®‰è£…uvå·¥å…·
curl -sSf https://astral.sh/uv/install.sh | bash

# æ·»åŠ uvåˆ°PATH (å¦‚æœå®‰è£…è„šæœ¬æ²¡æœ‰è‡ªåŠ¨æ·»åŠ )
export PATH="$HOME/.cargo/bin:$PATH"
echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc

# éªŒè¯uvå®‰è£…
uv --version
```

### å®‰è£…æ•°æ®åº“

```bash
# å®‰è£…MySQL
apt install -y mysql-server

# å¯åŠ¨MySQLæœåŠ¡
systemctl start mysql
systemctl enable mysql

# é…ç½®MySQLå®‰å…¨è®¾ç½®
mysql_secure_installation
```

> **ğŸ’¡ æç¤º**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè®°å¾—è®¾ç½®å¼ºå¯†ç å¹¶ç¦ç”¨åŒ¿åç”¨æˆ·

åœ¨ MySQL æç¤ºç¬¦ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ï¼š

```sql
CREATE DATABASE ai_assistant CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'ai_user'@'localhost' IDENTIFIED BY 'è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ';
GRANT ALL PRIVILEGES ON ai_assistant.* TO 'ai_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

æˆ–è€…ï¼Œä½ å¯ä»¥ç›´æ¥å¯¼å…¥é¡¹ç›®çš„ init_database.sql æ–‡ä»¶ï¼š

```bash
mysql -u root -p < init_database.sql
```

### å®‰è£… Nginx

```bash
# å®‰è£…Nginx
apt install -y nginx

# å¯åŠ¨NginxæœåŠ¡
systemctl start nginx
systemctl enable nginx

# éªŒè¯Nginxæ˜¯å¦æ­£å¸¸è¿è¡Œ
systemctl status nginx
```

### é…ç½®é˜²ç«å¢™

```bash
# å®‰è£…å¹¶é…ç½®ufw
apt install -y ufw
ufw allow ssh
ufw allow http
ufw allow https
ufw enable

# éªŒè¯é˜²ç«å¢™è§„åˆ™
ufw status
```

> **âš ï¸ æ³¨æ„**: åœ¨å¯ç”¨é˜²ç«å¢™å‰ï¼Œç¡®ä¿å·²æ·»åŠ  SSH è§„åˆ™ï¼Œå¦åˆ™å¯èƒ½ä¼šæ–­å¼€å½“å‰è¿æ¥

åŒæ—¶ï¼Œç¡®ä¿åœ¨è…¾è®¯äº‘æ§åˆ¶å°çš„å®‰å…¨ç»„ä¸­æ”¾è¡Œä»¥ä¸‹ç«¯å£ï¼š

- 22 ç«¯å£(SSH)
- 80 ç«¯å£(HTTP)
- 443 ç«¯å£(HTTPS)

## FastAPI åç«¯éƒ¨ç½²

### ä»£ç éƒ¨ç½²

ä½¿ç”¨ deploy ç”¨æˆ·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# åˆ‡æ¢åˆ°deployç”¨æˆ·(å¦‚æœå°šæœªåˆ‡æ¢)
su - deploy

# è¿›å…¥åº”ç”¨ç›®å½•
cd /var/www/ai_assistant

# æ‹‰å–ä»£ç 
git clone https://ä½ çš„åç«¯ä»“åº“åœ°å€ backend
cd backend
```

### è™šæ‹Ÿç¯å¢ƒé…ç½®

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# ä½¿ç”¨uvå®‰è£…ä¾èµ–
uv pip install -r requirements.txt

# ç¡®è®¤ä¾èµ–å®‰è£…æˆåŠŸ
pip list
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œæ¨èä½¿ç”¨ä¸“é—¨çš„ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œä»¥ç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸‹çš„ç¨³å®šè¿è¡Œã€‚æˆ‘ä»¬æä¾›ä¸¤ç§ç¯å¢ƒå˜é‡é…ç½®æ–¹å¼ï¼š

**æ–¹å¼ 1ï¼šä½¿ç”¨.env æ–‡ä»¶ï¼ˆåŸºç¡€æ–¹å¼ï¼‰**

```bash
# åˆ›å»ºæˆ–ç¼–è¾‘ç¯å¢ƒé…ç½®æ–‡ä»¶
vi .env
```

æ ¹æ® config.py æ–‡ä»¶çš„å†…å®¹ï¼Œæ·»åŠ å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼š

```ini
# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql+pymysql://ai_user:è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç @localhost/ai_assistant

# åº”ç”¨é…ç½®
DEBUG=False
SECRET_KEY=ç”Ÿæˆä¸€ä¸ªå®‰å…¨çš„éšæœºå¯†é’¥  # å¯ä»¥ä½¿ç”¨ openssl rand -hex 32 ç”Ÿæˆ
ALLOW_ORIGINS=https://ä½ çš„åŸŸå.com

# å…¶ä»–é…ç½®
LOG_LEVEL=info
```

**æ–¹å¼ 2ï¼šä½¿ç”¨.env.production æ–‡ä»¶ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰**

```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒä¸“ç”¨é…ç½®æ–‡ä»¶
vi .env.production
```

é…ç½®å†…å®¹ç¤ºä¾‹ï¼š

```ini
# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql+pymysql://ai_user:è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç @localhost/ai_assistant

# åº”ç”¨é…ç½®
DEBUG=False
ENVIRONMENT=production
SECRET_KEY=ç”Ÿæˆä¸€ä¸ªå®‰å…¨çš„éšæœºå¯†é’¥  # å¯ä»¥ä½¿ç”¨ openssl rand -hex 32 ç”Ÿæˆ
ALLOW_ORIGINS=https://ä½ çš„åŸŸå.com

# APIé…ç½®
API_VERSION=v1
API_PREFIX=/api/v1

# å®‰å…¨é…ç½®
TOKEN_EXPIRE_MINUTES=1440  # 24å°æ—¶
ALGORITHM=HS256

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=json  # ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºåæœŸåˆ†æ

# æ€§èƒ½é…ç½®
WORKERS_PER_CORE=1
MAX_WORKERS=4
```

> ğŸ’¡ **æœ€ä½³å®è·µ**: ä½¿ç”¨ä¸“é—¨çš„`.env.production`æ–‡ä»¶å¯ä»¥å¸®åŠ©åˆ†ç¦»å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒé…ç½®ï¼Œé¿å…æ„å¤–ä½¿ç”¨å¼€å‘é…ç½®ä¸Šçº¿ã€‚ç”Ÿäº§é…ç½®åº”å½“æ›´ä¸¥æ ¼ã€æ›´å®‰å…¨ï¼Œä¸”é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–ã€‚

### æ•°æ®åº“åˆå§‹åŒ–

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ(å¦‚æœå°šæœªæ¿€æ´»)
source .venv/bin/activate

# å¯¼å…¥æ•°æ®åº“ç»“æ„
mysql -u ai_user -p ai_assistant < init_database.sql
```

### åº”ç”¨å¯åŠ¨æ–¹æ¡ˆ

FastAPI åç«¯æœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ç§å³å¯ï¼š

#### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ uvicorn ç›´æ¥å¯åŠ¨ï¼ˆç®€å•ä½†é€‚åˆå¼€å‘å’Œæµ‹è¯•ï¼‰

**ä½¿ç”¨åŸºç¡€ç¯å¢ƒé…ç½®å¯åŠ¨:**

```bash
# å®‰è£…uvicorn
uv pip install uvicorn

# å¯åŠ¨åº”ç”¨
cd /var/www/ai_assistant/backend
source .venv/bin/activate

# ä½¿ç”¨nohupåœ¨åå°è¿è¡Œ
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &

# æ£€æŸ¥æ˜¯å¦è¿è¡Œ
ps aux | grep uvicorn
```

**ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®å¯åŠ¨:**

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
cd /var/www/ai_assistant/backend
source .venv/bin/activate

# ä½¿ç”¨.env.productioné…ç½®å¯åŠ¨
nohup uvicorn main:app --env-file .env.production --host 0.0.0.0 --port 8000 > app.log 2>&1 &
```

> **âš ï¸ å±€é™æ€§**:
>
> - æœåŠ¡å™¨é‡å¯åéœ€è¦æ‰‹åŠ¨å¯åŠ¨
> - åº”ç”¨å´©æºƒä¸ä¼šè‡ªåŠ¨é‡å¯
> - å•è¿›ç¨‹è¿è¡Œï¼Œæ€§èƒ½æœ‰é™
> - ä¸ä¾¿äºæ—¥å¿—ç®¡ç†

#### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Gunicorn + Supervisorï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

1. å®‰è£…å¿…è¦ç»„ä»¶ï¼š

```bash
# åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…Gunicornå’Œuvicorn
uv pip install gunicorn uvicorn

# ä½¿ç”¨sudoå®‰è£…Supervisor
sudo apt install -y supervisor
```

2. åˆ›å»º Gunicorn é…ç½®æ–‡ä»¶ï¼š

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /var/www/ai_assistant/backend/gunicorn
vi /var/www/ai_assistant/backend/gunicorn/gunicorn.conf.py
```

é…ç½®æ–‡ä»¶å†…å®¹ï¼š

```python
# Gunicorné…ç½®æ–‡ä»¶
import multiprocessing
import os

# è·å–ç¯å¢ƒå˜é‡ä¸­çš„é…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
workers_per_core_str = os.getenv("WORKERS_PER_CORE", "1")
max_workers_str = os.getenv("MAX_WORKERS", "4")
use_max_workers = None if max_workers_str is None else int(max_workers_str)

cores = multiprocessing.cpu_count()
workers_per_core = float(workers_per_core_str)
default_web_concurrency = int(workers_per_core * cores) + 1
web_concurrency = min(use_max_workers or default_web_concurrency, default_web_concurrency)

# æœ€ç»ˆé…ç½®
bind = "127.0.0.1:8000"
workers = web_concurrency
worker_class = "uvicorn.workers.UvicornWorker"
max_requests = 1000
max_requests_jitter = 50
timeout = 60
keepalive = 5

# æ—¥å¿—é…ç½®
errorlog = "/var/log/gunicorn/error.log"
accesslog = "/var/log/gunicorn/access.log"
loglevel = os.getenv("LOG_LEVEL", "info")
```

3. åˆ›å»º Supervisor é…ç½®:

```bash
sudo vi /etc/supervisor/conf.d/ai_assistant.conf
```

**åŸºç¡€é…ç½®ï¼ˆä½¿ç”¨.env æ–‡ä»¶ï¼‰**:

```
[program:ai_assistant]
directory=/var/www/ai_assistant/backend
command=/var/www/ai_assistant/backend/.venv/bin/gunicorn -c gunicorn/gunicorn.conf.py main:app
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
environment=PATH="/var/www/ai_assistant/backend/.venv/bin",PYTHONPATH="/var/www/ai_assistant/backend"
redirect_stderr=true
stdout_logfile=/var/log/ai_assistant.log
stderr_logfile=/var/log/ai_assistant_error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆä½¿ç”¨.env.production æ–‡ä»¶ï¼‰**:

```
[program:ai_assistant]
directory=/var/www/ai_assistant/backend
command=/var/www/ai_assistant/backend/.venv/bin/gunicorn -c gunicorn/gunicorn.conf.py main:app
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
environment=PATH="/var/www/ai_assistant/backend/.venv/bin",PYTHONPATH="/var/www/ai_assistant/backend",ENV_FILE=".env.production"
redirect_stderr=true
stdout_logfile=/var/log/ai_assistant.log
stderr_logfile=/var/log/ai_assistant_error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
```

4. å¯åŠ¨åº”ç”¨:

```bash
# é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# å¯åŠ¨åº”ç”¨
sudo supervisorctl start ai_assistant

# æ£€æŸ¥çŠ¶æ€
sudo supervisorctl status
```

> **ğŸ’¡ æç¤º**:
>
> - ä½¿ç”¨ `sudo supervisorctl restart ai_assistant` é‡å¯åº”ç”¨
> - ä½¿ç”¨ `sudo supervisorctl stop ai_assistant` åœæ­¢åº”ç”¨
> - ä½¿ç”¨ `sudo supervisorctl tail ai_assistant` æŸ¥çœ‹å®æ—¶æ—¥å¿—

### åå‘ä»£ç†é…ç½®

ä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†ï¼š

```bash
sudo vi /etc/nginx/sites-available/ai_assistant
```

é…ç½®å†…å®¹ï¼š

```nginx
server {
    listen 80;
    server_name api.ä½ çš„åŸŸå.com;
    return 301 https://$host$request_uri;  # HTTP é‡å®šå‘åˆ° HTTPS
}

server {
    listen 443 ssl;
    server_name api.ä½ çš„åŸŸå.com;

    ssl_certificate /etc/nginx/ssl/ä½ çš„åŸŸå_bundle.crt;
    ssl_certificate_key /etc/nginx/ssl/ä½ çš„åŸŸå.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # HSTS å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000" always;

    # CORS è®¾ç½®
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/ai_assistant_access.log;
    error_log /var/log/nginx/ai_assistant_error.log;

    # è¯·æ±‚å¤§å°é™åˆ¶
    client_max_body_size 10M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /ws {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
}
```

5. **æ£€æŸ¥é…ç½®å¹¶é‡å¯ Nginx**:

   ```bash
   sudo nginx -t
   sudo systemctl restart nginx
   ```

6. **æµ‹è¯• HTTPS è®¿é—®**:
   ```
   https://api.ä½ çš„åŸŸå.com
   ```

## uni-app å°ç¨‹åºå‰ç«¯å‘å¸ƒ

### é…ç½®é¡¹ç›®

1. **æ‰“å¼€ HBuilder é¡¹ç›®**

2. **é…ç½® API åœ°å€**

   ä¿®æ”¹ API é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ä½äº `utils` æˆ– `api` ç›®å½•ï¼š

   ```javascript
   // ç¤ºä¾‹é…ç½®
   const config = {
     // å¼€å‘ç¯å¢ƒ
     development: {
       BASE_URL: "http://localhost:8000/api",
     },
     // ç”Ÿäº§ç¯å¢ƒ
     production: {
       BASE_URL: "https://api.ä½ çš„åŸŸå.com/api",
     },
   };

   // æ ¹æ®ç¯å¢ƒé€‰æ‹©é…ç½®
   export default config[process.env.NODE_ENV || "production"];
   ```

3. **æ›´æ–°å°ç¨‹åºä¿¡æ¯**

   åœ¨ `manifest.json` ä¸­æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š

   - AppID æ˜¯å¦æ­£ç¡®
   - ç‰ˆæœ¬å·æ˜¯å¦å·²æ›´æ–°
   - æ‰€éœ€æƒé™æ˜¯å¦é…ç½®

### ç¼–è¯‘ä¸æµ‹è¯•

1. **æœ¬åœ°æµ‹è¯•**

   åœ¨ç¼–è¯‘å‰ï¼Œå…ˆåœ¨æœ¬åœ°æµ‹è¯•ï¼š

   - ä½¿ç”¨ HBuilder çœŸæœºé¢„è§ˆåŠŸèƒ½
   - ç¡®ä¿æ‰€æœ‰ API æ¥å£èƒ½æ­£å¸¸è°ƒç”¨
   - æ£€æŸ¥å„åŠŸèƒ½æ˜¯å¦æ­£å¸¸

2. **ç¼–è¯‘æ„å»º**

   ```
   1. ç‚¹å‡» HBuilder é¡¶éƒ¨èœå•çš„"å‘è¡Œ"
   2. é€‰æ‹©"å°ç¨‹åº-å¾®ä¿¡"
   3. æŒ‰éœ€è°ƒæ•´ç¼–è¯‘å‚æ•°
   4. ç‚¹å‡»å‘è¡Œ
   5. ç­‰å¾…ç¼–è¯‘å®Œæˆ
   ```

   > **ğŸ’¡ æç¤º**: ç¼–è¯‘å®Œæˆåï¼Œä»£ç åŒ…é€šå¸¸ä½äº `unpackage/dist/build/mp-weixin` ç›®å½•

### å‘å¸ƒä¸å®¡æ ¸

1. **å¯¼å…¥å¾®ä¿¡å¼€å‘è€…å·¥å…·**

   - æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
   - å¯¼å…¥ HBuilder ç”Ÿæˆçš„å°ç¨‹åºåŒ…
   - ç¡®ä¿ AppID ä¸é¡¹ç›®é…ç½®ä¸€è‡´

2. **è°ƒè¯•ä¸é¢„è§ˆ**

   - æ£€æŸ¥ç•Œé¢æ ·å¼æ˜¯å¦æ­£ç¡®
   - æµ‹è¯•å…³é”®åŠŸèƒ½å’Œ API æ¥å£
   - ç¡®ä¿ç¬¦åˆå°ç¨‹åºè§„èŒƒ

3. **é…ç½®æœåŠ¡å™¨åŸŸå**

   åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç®¡ç†åå°ï¼š

   - è¿›å…¥"å¼€å‘"->"å¼€å‘è®¾ç½®"->"æœåŠ¡å™¨åŸŸå"
   - æ·»åŠ  request åˆæ³•åŸŸåï¼š`https://api.ä½ çš„åŸŸå.com`
   - å¦‚æœ‰ä¸Šä¼ åŠŸèƒ½ï¼Œæ·»åŠ  uploadFile åˆæ³•åŸŸå

4. **ä¸Šä¼ å°ç¨‹åºä»£ç **

   - ç‚¹å‡»å¼€å‘è€…å·¥å…·ä¸­çš„"ä¸Šä¼ "æŒ‰é’®
   - å¡«å†™ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ 1.0.0ï¼‰
   - æ·»åŠ ç‰ˆæœ¬è¯´æ˜

5. **æäº¤å®¡æ ¸**

   åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ï¼š

   - è¿›å…¥"ç®¡ç†"->"ç‰ˆæœ¬ç®¡ç†"
   - é€‰æ‹©ä¸Šä¼ çš„ç‰ˆæœ¬ï¼Œæäº¤å®¡æ ¸
   - å¡«å†™å®Œæ•´çš„å®¡æ ¸èµ„æ–™ï¼š
     - åŠŸèƒ½æè¿°
     - æµ‹è¯•è´¦å·(å¦‚éœ€)
     - éšç§åè®®
     - ç•Œé¢æˆªå›¾

6. **å‘å¸ƒä¸Šçº¿**

   å®¡æ ¸é€šè¿‡åï¼š

   - åœ¨ç‰ˆæœ¬ç®¡ç†ä¸­ç‚¹å‡»"å‘å¸ƒ"
   - ç¡®è®¤å‘å¸ƒä¿¡æ¯
   - å°ç¨‹åºæ­£å¼ä¸Šçº¿

## åŸŸåé…ç½®ä¸ SSL è¯ä¹¦

### åŸŸåè§„åˆ’

ä¸ºäº†ä¾¿äºæœªæ¥æ‰©å±•ï¼Œå»ºè®®è§„åˆ’åŸŸåç»“æ„å¦‚ä¸‹ï¼š

```
ä¸»åŸŸå: ä½ çš„åŸŸå.com
|
â”œâ”€â”€ api.ä½ çš„åŸŸå.com     (åç«¯APIæœåŠ¡)
|
â”œâ”€â”€ admin.ä½ çš„åŸŸå.com   (ç®¡ç†åå°ï¼Œæœªæ¥å¯ç”¨)
|
â””â”€â”€ www.ä½ çš„åŸŸå.com     (ç½‘ç«™å‰ç«¯ï¼Œæœªæ¥å¯ç”¨)
```

> **ğŸ’¡ å»ºè®®**:
>
> - ä¸ºä¸åŒæœåŠ¡ä½¿ç”¨å­åŸŸåå¯ä»¥æ›´çµæ´»åœ°ç®¡ç†
> - API ç‰ˆæœ¬å¯ä»¥é€šè¿‡è·¯å¾„åŒºåˆ†ï¼ˆå¦‚ `/v1/api`ï¼‰æˆ–ä½¿ç”¨å­åŸŸå

### åŸŸåè§£æ

1. **ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°** â†’ åŸŸåä¸ç½‘ç«™ â†’ åŸŸåç®¡ç†

2. **æ‰¾åˆ°ä½ çš„åŸŸå**ï¼Œç‚¹å‡»"è§£æ"

3. **æ·»åŠ è®°å½•**ï¼š

   - **ä¸»æœºè®°å½•**: `api` (å°†åˆ›å»º api.ä½ çš„åŸŸå.com)
   - **è®°å½•ç±»å‹**: A è®°å½•
   - **è®°å½•å€¼**: ä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP
   - **TTL**: é»˜è®¤å€¼ 600 ç§’

4. **éªŒè¯è§£æ**ï¼š
   ```bash
   nslookup api.ä½ çš„åŸŸå.com
   ```

### åŸŸåå¤‡æ¡ˆ

> **âš ï¸ é‡è¦**: åœ¨ä¸­å›½å¤§é™†æœåŠ¡å™¨ä¸Šä½¿ç”¨åŸŸåå¿…é¡»å®Œæˆå¤‡æ¡ˆ

1. **å¤‡æ¡ˆæµç¨‹**:

   - ç™»å½•è…¾è®¯äº‘å¤‡æ¡ˆç³»ç»Ÿ
   - å‡†å¤‡ä¸ªäººæˆ–ä¼ä¸šè¯ä»¶
   - å¡«å†™ç½‘ç«™ä¿¡æ¯
   - çœŸå®æ€§æ ¸éªŒï¼ˆäººè„¸è¯†åˆ«æˆ–å¹•å¸ƒç…§ç‰‡ï¼‰
   - ç­‰å¾…å·¥ä¿¡éƒ¨å®¡æ ¸ï¼ˆ1-20 ä¸ªå·¥ä½œæ—¥ï¼‰

2. **å¤‡æ¡ˆå®Œæˆå**:
   - ç½‘ç«™éœ€å±•ç¤ºå¤‡æ¡ˆå·
   - ä¿æŒç½‘ç«™å†…å®¹ä¸å¤‡æ¡ˆä¿¡æ¯ä¸€è‡´

### SSL è¯ä¹¦é…ç½®

1. **ç”³è¯·è¯ä¹¦**:

   - è…¾è®¯äº‘æ§åˆ¶å° â†’ SSL è¯ä¹¦
   - ç”³è¯·å…è´¹ DV è¯ä¹¦
   - é€‰æ‹©åŸŸå `api.ä½ çš„åŸŸå.com`
   - æ¨èä½¿ç”¨ DNS éªŒè¯æ–¹å¼

2. **éªŒè¯åŸŸåæ‰€æœ‰æƒ**

   - æŒ‰ç…§æç¤ºå®ŒæˆåŸŸåéªŒè¯
   - ç­‰å¾…è¯ä¹¦é¢å‘ï¼ˆé€šå¸¸å‡ å°æ—¶å†…ï¼‰

3. **å®‰è£…è¯ä¹¦**:

   ```bash
   # åˆ›å»ºè¯ä¹¦ç›®å½•
   sudo mkdir -p /etc/nginx/ssl

   # å°†ä¸‹è½½çš„è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡å™¨
   # è®¾ç½®æƒé™
   sudo chmod 600 /etc/nginx/ssl/*
   ```

4. **é…ç½® HTTPS**:

   ```bash
   sudo vi /etc/nginx/sites-available/ai_assistant
   ```

   ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹:

   ```nginx
   server {
       listen 80;
       server_name api.ä½ çš„åŸŸå.com;
       return 301 https://$host$request_uri;  # HTTP é‡å®šå‘åˆ° HTTPS
   }

   server {
       listen 443 ssl;
       server_name api.ä½ çš„åŸŸå.com;

       ssl_certificate /etc/nginx/ssl/ä½ çš„åŸŸå_bundle.crt;
       ssl_certificate_key /etc/nginx/ssl/ä½ çš„åŸŸå.key;

       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_prefer_server_ciphers on;
       ssl_session_cache shared:SSL:10m;
       ssl_session_timeout 10m;

       # HSTS å®‰å…¨å¤´
       add_header Strict-Transport-Security "max-age=31536000" always;

       # CORS è®¾ç½®
       add_header 'Access-Control-Allow-Origin' '*';
       add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
       add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

       # æ—¥å¿—é…ç½®
       access_log /var/log/nginx/ai_assistant_access.log;
       error_log /var/log/nginx/ai_assistant_error.log;

       # è¯·æ±‚å¤§å°é™åˆ¶
       client_max_body_size 10M;

       location / {
           proxy_pass http://127.0.0.1:8000;
           proxy_http_version 1.1;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }

       location /ws {
           proxy_pass http://127.0.0.1:8000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
           proxy_read_timeout 86400;
       }
   }
   ```

5. **æ£€æŸ¥é…ç½®å¹¶é‡å¯ Nginx**:

   ```bash
   sudo nginx -t
   sudo systemctl restart nginx
   ```

6. **æµ‹è¯• HTTPS è®¿é—®**:
   ```
   https://api.ä½ çš„åŸŸå.com
   ```

## æ—¥å¿—ç®¡ç†ä¸ç›‘æ§

### æ—¥å¿—é…ç½®

1. **Nginx æ—¥å¿—**:

   - è®¿é—®æ—¥å¿—: `/var/log/nginx/ai_assistant_access.log`
   - é”™è¯¯æ—¥å¿—: `/var/log/nginx/ai_assistant_error.log`

2. **åº”ç”¨æ—¥å¿—**:

   - Gunicorn æ—¥å¿—: `/var/log/gunicorn/error.log` å’Œ `/var/log/gunicorn/access.log`
   - åº”ç”¨æ—¥å¿—: `/var/log/ai_assistant.log` å’Œ `/var/log/ai_assistant_error.log`

3. **FastAPI å†…éƒ¨æ—¥å¿—**:

   åœ¨åº”ç”¨ä»£ç ä¸­æ·»åŠ :

   ```python
   import logging
   from logging.handlers import RotatingFileHandler

   def setup_logging():
       logger = logging.getLogger("app")
       logger.setLevel(logging.INFO)

       file_handler = RotatingFileHandler(
           "/var/log/app/api.log",
           maxBytes=10*1024*1024,  # 10MB
           backupCount=5
       )

       formatter = logging.Formatter(
           '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
       )
       file_handler.setFormatter(formatter)
       logger.addHandler(file_handler)

       return logger

   app_logger = setup_logging()

   # ä½¿ç”¨æ–¹æ³•
   @app.get("/items/{item_id}")
   async def read_item(item_id: int):
       app_logger.info(f"è¯»å–é¡¹ç›®ID: {item_id}")
       # ä¸šåŠ¡é€»è¾‘...
   ```

### æ—¥å¿—è½®è½¬

é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼Œé…ç½®æ—¥å¿—è½®è½¬:

```bash
sudo vi /etc/logrotate.d/ai_assistant
```

é…ç½®å†…å®¹:

```
/var/log/nginx/ai_assistant_*.log
/var/log/gunicorn/*.log
/var/log/ai_assistant*.log
/var/log/app/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 640 root adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

æµ‹è¯•é…ç½®:

```bash
sudo logrotate -d /etc/logrotate.d/ai_assistant
```

### ç›‘æ§ä¸æŠ¥è­¦

1. **å®æ—¶æ—¥å¿—ç›‘æ§**:

   ```bash
   # å®æ—¶æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
   sudo tail -f /var/log/nginx/ai_assistant_access.log

   # å®æ—¶æŸ¥çœ‹åº”ç”¨é”™è¯¯æ—¥å¿—
   sudo tail -f /var/log/ai_assistant_error.log
   ```

2. **å¸¸ç”¨æ—¥å¿—åˆ†æå‘½ä»¤**:

   ```bash
   # æŸ¥çœ‹é”™è¯¯çŠ¶æ€ç 
   grep " 500 " /var/log/nginx/ai_assistant_access.log

   # ç»Ÿè®¡è®¿é—®IPæ•°é‡
   awk '{print $1}' /var/log/nginx/ai_assistant_access.log | sort | uniq -c | sort -nr | head -10

   # åˆ†æçƒ­é—¨è¯·æ±‚
   awk '{print $7}' /var/log/nginx/ai_assistant_access.log | sort | uniq -c | sort -nr | head -10
   ```

3. **ç›‘æ§å·¥å…·æ¨è**:
   - è½»é‡çº§: GoAccess
   - ä¸­å‹é¡¹ç›®: Prometheus + Grafana
   - å¤§å‹é¡¹ç›®: ELK Stack æˆ– Loki

## å¸¸è§é—®é¢˜æ’æŸ¥

### æœåŠ¡å™¨é—®é¢˜

1. **æ— æ³•è¿æ¥æœåŠ¡å™¨**

   - æ£€æŸ¥ IP åœ°å€
   - ç¡®è®¤å®‰å…¨ç»„è§„åˆ™
   - æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç 

2. **ç£ç›˜ç©ºé—´ä¸è¶³**

   ```bash
   # æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
   df -h

   # æ‰¾å‡ºå¤§æ–‡ä»¶
   sudo find / -type f -size +100M -exec ls -lh {} \;
   ```

3. **å†…å­˜ä¸è¶³**

   ```bash
   # æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
   free -m

   # æ·»åŠ äº¤æ¢ç©ºé—´
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   ```

### ç½‘ç»œé—®é¢˜

1. **åŸŸåè§£æå¤±è´¥**

   ```bash
   # æ£€æŸ¥DNSè§£æ
   nslookup api.ä½ çš„åŸŸå.com

   # æ£€æŸ¥å¤‡æ¡ˆçŠ¶æ€
   å‘½ä»¤è¡Œæ— æ³•ç›´æ¥æŸ¥è¯¢ï¼Œéœ€åœ¨å·¥ä¿¡éƒ¨ç½‘ç«™æŸ¥è¯¢
   ```

2. **SSL è¯ä¹¦é—®é¢˜**

   ```bash
   # æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
   openssl x509 -in /etc/nginx/ssl/ä½ çš„åŸŸå_bundle.crt -noout -dates

   # æµ‹è¯•SSLé…ç½®
   curl -vI https://api.ä½ çš„åŸŸå.com
   ```

3. **Nginx é…ç½®é—®é¢˜**

   ```bash
   # æ£€æŸ¥Nginxé…ç½®
   sudo nginx -t

   # æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
   sudo tail -f /var/log/nginx/error.log
   ```

### åº”ç”¨é—®é¢˜

1. **FastAPI å¯åŠ¨å¤±è´¥**

   ```bash
   # æ£€æŸ¥Supervisoræ—¥å¿—
   sudo supervisorctl status ai_assistant
   sudo cat /var/log/ai_assistant_error.log

   # æ‰‹åŠ¨å¯åŠ¨æ£€æŸ¥é”™è¯¯
   cd /var/www/ai_assistant/backend
   source .venv/bin/activate
   python -m uvicorn main:app --host 127.0.0.1
   ```

2. **æ•°æ®åº“è¿æ¥é—®é¢˜**

   ```bash
   # æ£€æŸ¥MySQLè¿è¡ŒçŠ¶æ€
   sudo systemctl status mysql

   # æ£€æŸ¥ç”¨æˆ·æƒé™
   mysql -u ai_user -p -e "SHOW GRANTS"
   ```

3. **å°ç¨‹åº API è¯·æ±‚å¤±è´¥**
   - æ£€æŸ¥å°ç¨‹åºåŸŸåé…ç½®ï¼ˆrequest åˆæ³•åŸŸåï¼‰
   - ç¡®è®¤ API åœ°å€é…ç½®æ­£ç¡®
   - æ£€æŸ¥ HTTPS è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
   - éªŒè¯ CORS é…ç½®æ˜¯å¦æ­£ç¡®

### æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ä¼˜åŒ–**

   ```bash
   # æŸ¥çœ‹æ…¢æŸ¥è¯¢
   sudo cat /var/log/mysql/slow.log

   # ä¼˜åŒ–æ­¥éª¤
   - æ·»åŠ åˆé€‚çš„ç´¢å¼•
   - ä¼˜åŒ–SQLæŸ¥è¯¢
   - é…ç½®MySQLç¼“å­˜
   ```

2. **åº”ç”¨æ€§èƒ½ä¼˜åŒ–**

   ```bash
   # å¢åŠ Gunicornå·¥ä½œè¿›ç¨‹
   ä¿®æ”¹gunicorn.conf.pyä¸­çš„workerså€¼

   # æ·»åŠ Redisç¼“å­˜
   sudo apt install redis-server
   ```

3. **Nginx ä¼˜åŒ–**

   ```bash
   # å¼€å¯gzipå‹ç¼©
   sudo vi /etc/nginx/nginx.conf

   # åœ¨httpå—æ·»åŠ 
   gzip on;
   gzip_comp_level 5;
   gzip_min_length 256;
   gzip_proxied any;
   gzip_types
     application/javascript
     application/json
     text/css
     text/plain;
   ```

## ç³»ç»Ÿå‡çº§æ–¹æ¡ˆ

éšç€ä¸šåŠ¡å‘å±•ï¼Œç³»ç»Ÿéœ€è¦å®šæœŸå‡çº§ä»¥æ·»åŠ æ–°åŠŸèƒ½ã€ä¿®å¤æ¼æ´æˆ–ä¼˜åŒ–æ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯ä¸€å¥—å®Œæ•´çš„ç³»ç»Ÿå‡çº§æ–¹æ¡ˆï¼Œå¸®åŠ©æ‚¨åœ¨æœ€å°åŒ–åœæœºæ—¶é—´çš„æƒ…å†µä¸‹å®‰å…¨åœ°æ›´æ–°ç³»ç»Ÿã€‚

### åç«¯å‡çº§æµç¨‹

1. **å‡çº§å‰å‡†å¤‡**

   ```bash
   # åˆ›å»ºæ•°æ®åº“å¤‡ä»½
   mysqldump -u ai_user -p ai_assistant > /var/backups/ai_assistant_$(date +%Y%m%d).sql

   # å¤‡ä»½ä»£ç å’Œç¯å¢ƒé…ç½®
   cd /var/www/ai_assistant
   cp -r backend backend_backup_$(date +%Y%m%d)
   cp backend/.env.production backend_backup_$(date +%Y%m%d)/
   ```

2. **è·å–æ–°ä»£ç **

   ```bash
   # è¿›å…¥é¡¹ç›®ç›®å½•
   cd /var/www/ai_assistant/backend

   # å¦‚æœä½¿ç”¨Gitç®¡ç†
   git fetch
   git checkout tags/v1.x.x  # æ›¿æ¢ä¸ºç›®æ ‡ç‰ˆæœ¬å·

   # æˆ–è€…ç›´æ¥è·å–æ–°ä»£ç 
   # å…ˆå¤‡ä»½ç°æœ‰ç¯å¢ƒæ–‡ä»¶
   cp .env.production /tmp/.env.production.bak
   rm -rf /var/www/ai_assistant/backend/*
   cp -r /path/to/new/code/* /var/www/ai_assistant/backend/
   # æ¢å¤ç¯å¢ƒæ–‡ä»¶
   cp /tmp/.env.production.bak /var/www/ai_assistant/backend/.env.production
   ```

3. **æ›´æ–°ä¾èµ–**

   ```bash
   # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
   source .venv/bin/activate

   # æ›´æ–°ä¾èµ–
   uv pip install -r requirements.txt
   ```

4. **åº”ç”¨æ•°æ®åº“å˜æ›´**

   ```bash
   # å¦‚æœæœ‰è¿ç§»è„šæœ¬
   python3 scripts/migrate.py

   # æˆ–æ‰§è¡ŒSQLè„šæœ¬
   mysql -u ai_user -p ai_assistant < migrations/v1.x.x.sql
   ```

5. **æµ‹è¯•æ–°ç‰ˆæœ¬**

   ```bash
   # åœ¨å¦ä¸€ä¸ªç«¯å£ä¸Šå¯åŠ¨æµ‹è¯•ç‰ˆæœ¬
   uvicorn main:app --env-file .env.production --host 127.0.0.1 --port 8001

   # åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä½¿ç”¨curlæµ‹è¯•API
   curl http://127.0.0.1:8001/api/health
   curl http://127.0.0.1:8001/api/v1/version
   ```

6. **éƒ¨ç½²æ–°ç‰ˆæœ¬**

   ```bash
   # é‡å¯åº”ç”¨
   sudo supervisorctl restart ai_assistant

   # ç›‘æ§æ—¥å¿—ç¡®è®¤å¯åŠ¨æ­£å¸¸
   sudo supervisorctl tail ai_assistant
   ```

### å‰ç«¯å‡çº§æµç¨‹

1. **åˆ›å»ºæ–°ç‰ˆæœ¬**

   ```
   # åœ¨å¼€å‘ç¯å¢ƒå‡†å¤‡å¹¶æµ‹è¯•æ–°ç‰ˆæœ¬
   # ç¡®ä¿æ–°ç‰ˆæœ¬å·²é€šè¿‡å®Œæ•´çš„æµ‹è¯•ä¸”èƒ½æ­£ç¡®è¿æ¥åç«¯API
   ```

2. **å‘å¸ƒå‰æ£€æŸ¥æ¸…å•**

   - ç¡®è®¤ API åœ°å€æ­£ç¡®æŒ‡å‘ç”Ÿäº§ç¯å¢ƒ
   - ç¡®è®¤ç‰ˆæœ¬å·å·²æ›´æ–°ï¼ˆmanifest.jsonï¼‰
   - ç¡®è®¤ AppID é…ç½®æ­£ç¡®
   - æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æƒé™éœ€è¦ç”³è¯·
   - ç¡®è®¤å›¾ç‰‡ã€èµ„æºæ–‡ä»¶å·²ä¼˜åŒ–
   - ç§»é™¤æ‰€æœ‰è°ƒè¯•ä»£ç å’Œæ§åˆ¶å°æ—¥å¿—

3. **ç¼–è¯‘ä¸æµ‹è¯•**

   ```
   # ä½¿ç”¨HBuilderå®Œæˆç¼–è¯‘
   1. ç‚¹å‡»"å‘è¡Œ"â†’"å°ç¨‹åº-å¾®ä¿¡"
   2. ç¡®ä¿å·²é€‰æ‹©"å‘è¡Œ"æ¨¡å¼ï¼ˆé"å¼€å‘"æ¨¡å¼ï¼‰
   3. å®Œæˆç¼–è¯‘
   ```

4. **å¤‡ä»½å½“å‰ç‰ˆæœ¬**

   å¦‚æœä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶:

   ```bash
   # ä¸ºå½“å‰ç‰ˆæœ¬åˆ›å»ºæ ‡ç­¾
   git tag -a v1.x.x -m "Version 1.x.x"
   git push origin v1.x.x
   ```

   å¦‚æœä¸ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶:

   ```bash
   # åˆ›å»ºå¤‡ä»½æ–‡ä»¶å¤¹
   mkdir -p /path/to/backups

   # å¤åˆ¶å½“å‰ç‰ˆæœ¬ä»£ç 
   cp -r /path/to/frontend /path/to/backups/frontend_v1.x.x
   ```

5. **ä¸Šä¼ ä¸å®¡æ ¸**

   ```
   # åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ä¸Šä¼ ä»£ç 
   # åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æäº¤å®¡æ ¸
   # ç­‰å¾…å®¡æ ¸é€šè¿‡åå‘å¸ƒ
   ```

### æ•°æ®åº“å‡çº§

1. **åˆ›å»ºå®Œæ•´å¤‡ä»½**

   ```bash
   # åˆ›å»ºæ•°æ®åº“å¤‡ä»½
   mysqldump -u ai_user -p --single-transaction ai_assistant > /var/backups/ai_assistant_full_$(date +%Y%m%d).sql
   ```

2. **å‡†å¤‡è¿ç§»è„šæœ¬**

   åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å˜æ›´çš„ SQL è„šæœ¬ï¼Œä¾‹å¦‚:

   ```sql
   -- v1.2.0å‡çº§è„šæœ¬
   -- æ·»åŠ æ–°è¡¨
   CREATE TABLE IF NOT EXISTS new_feature (
       id INT AUTO_INCREMENT PRIMARY KEY,
       name VARCHAR(100) NOT NULL,
       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );

   -- ä¿®æ”¹ç°æœ‰è¡¨
   ALTER TABLE existing_table ADD COLUMN new_column VARCHAR(50) DEFAULT NULL;

   -- æ·»åŠ ç´¢å¼•
   CREATE INDEX idx_new_column ON existing_table(new_column);
   ```

3. **æµ‹è¯•ç¯å¢ƒéªŒè¯**

   åœ¨æµ‹è¯•æ•°æ®åº“ä¸Šå…ˆéªŒè¯è¿ç§»è„šæœ¬:

   ```bash
   # åˆ›å»ºæµ‹è¯•æ•°æ®åº“
   mysql -u root -p -e "CREATE DATABASE ai_assistant_test;"

   # æ¢å¤ç”Ÿäº§æ•°æ®åˆ°æµ‹è¯•æ•°æ®åº“
   mysql -u root -p ai_assistant_test < /var/backups/ai_assistant_full_$(date +%Y%m%d).sql

   # åœ¨æµ‹è¯•æ•°æ®åº“ä¸Šè¿è¡Œè¿ç§»è„šæœ¬
   mysql -u root -p ai_assistant_test < migrations/v1.2.0.sql
   ```

4. **åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ**

   ```bash
   # åœæ­¢åº”ç”¨
   sudo supervisorctl stop ai_assistant

   # æ‰§è¡Œè¿ç§»è„šæœ¬
   mysql -u ai_user -p ai_assistant < migrations/v1.2.0.sql

   # é‡å¯åº”ç”¨
   sudo supervisorctl start ai_assistant
   ```

### ç‰ˆæœ¬å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡çº§åå‘ç°ä¸¥é‡é—®é¢˜éœ€è¦å›æ»š:

1. **åç«¯å›æ»š**

   ```bash
   # åœæ­¢å½“å‰åº”ç”¨
   sudo supervisorctl stop ai_assistant

   # æ¢å¤å¤‡ä»½ä»£ç 
   cd /var/www/ai_assistant
   rm -rf backend
   mv backend_backup_$(date +%Y%m%d) backend

   # æ¢å¤æ•°æ®åº“
   mysql -u ai_user -p ai_assistant < /var/backups/ai_assistant_$(date +%Y%m%d).sql

   # é‡å¯åº”ç”¨
   sudo supervisorctl start ai_assistant
   ```

2. **å‰ç«¯å›æ»š**

   ```
   # åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°åå°:
   1. è¿›å…¥"ç‰ˆæœ¬ç®¡ç†"
   2. æ‰¾åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
   3. ç‚¹å‡»"è®¾ä¸ºçº¿ä¸Šç‰ˆæœ¬"
   ```

### è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸æŒç»­é›†æˆ

å¯¹äºé¢‘ç¹æ›´æ–°çš„ç³»ç»Ÿï¼Œå¯ä»¥è€ƒè™‘å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²:

1. **æ­å»º CI/CD ç®¡é“**

   å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·:

   - Jenkins
   - GitHub Actions
   - GitLab CI/CD

2. **è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**

   åˆ›å»ºä¸€ä¸ªéƒ¨ç½²è„šæœ¬:

   ```bash
   #!/bin/bash
   # deploy.sh

   set -e  # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢

   # 1. æ‹‰å–ä»£ç 
   cd /var/www/ai_assistant/backend
   git pull origin main

   # 2. å®‰è£…ä¾èµ–
   source .venv/bin/activate
   uv pip install -r requirements.txt

   # 3. åº”ç”¨æ•°æ®åº“å˜æ›´
   python3 scripts/migrate.py

   # 4. é‡å¯åº”ç”¨
   sudo supervisorctl restart ai_assistant

   echo "Deployment completed successfully!"
   ```

   ä½¿è„šæœ¬å¯æ‰§è¡Œ:

   ```bash
   chmod +x deploy.sh
   ```

3. **è“ç»¿éƒ¨ç½²**

   å¯¹äºé›¶åœæœºå‡çº§ï¼Œå¯ä»¥å®ç°è“ç»¿éƒ¨ç½²:

   ```bash
   # åœ¨æ–°ç«¯å£å¯åŠ¨æ–°ç‰ˆæœ¬
   supervisorctl start ai_assistant_blue

   # æµ‹è¯•æ–°ç‰ˆæœ¬
   # ...æµ‹è¯•é€šè¿‡å

   # ä¿®æ”¹Nginxé…ç½®æŒ‡å‘æ–°ç‰ˆæœ¬
   sudo vi /etc/nginx/sites-available/ai_assistant
   # æ›´æ”¹proxy_passæŒ‡å‘æ–°ç«¯å£

   # é‡è½½Nginxé…ç½®
   sudo nginx -s reload

   # ç¡®è®¤æ— é—®é¢˜åå…³é—­æ—§ç‰ˆæœ¬
   supervisorctl stop ai_assistant_green
   ```

å®æ–½ä»¥ä¸Šå‡çº§æ–¹æ¡ˆæ—¶ï¼Œè¯·å§‹ç»ˆç‰¢è®°ä»¥ä¸‹åŸåˆ™:

- **å§‹ç»ˆå¤‡ä»½**: åœ¨ä»»ä½•æ›´æ”¹å‰åˆ›å»ºå®Œæ•´å¤‡ä»½
- **æµ‹è¯•å…ˆè¡Œ**: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ‰€æœ‰æ›´æ”¹
- **æ¸è¿›å¼å‘å¸ƒ**: è€ƒè™‘åˆ†æ‰¹æ¬¡ã€åˆ†åœ°åŒºå‘å¸ƒæ–°ç‰ˆæœ¬
- **ç›‘æ§å…³é”®æŒ‡æ ‡**: å¯†åˆ‡å…³æ³¨ç³»ç»Ÿæ€§èƒ½å’Œé”™è¯¯ç‡
- **å‡†å¤‡å›æ»šæ–¹æ¡ˆ**: ç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¿«é€Ÿæ¢å¤æœåŠ¡

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥åœ¨ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§çš„åŒæ—¶ï¼ŒæŒç»­æ”¹è¿›å’Œæ‰©å±•æ‚¨çš„åº”ç”¨ã€‚

ğŸ‰ å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ çš„é¡¹ç›®åº”è¯¥å·²ç»æˆåŠŸéƒ¨ç½²ï¼å¦‚æœ‰é—®é¢˜ï¼Œå»ºè®®æŸ¥çœ‹ç›¸åº”æ—¥å¿—ï¼Œæˆ–å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚
