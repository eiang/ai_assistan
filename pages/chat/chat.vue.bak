<template>
  <view class="chat-container">
    <!-- 顶部导航栏 -->
    <view class="chat-header">
      <view class="back-btn" @click="goBack">
        <tui-icon name="arrowleft"></tui-icon>
      </view>
      <view class="chat-title">AI 聊天助手</view>
      <view class="chat-settings" @click="goToSettings">
        <tui-icon name="setup"></tui-icon>
      </view>
    </view>
    
    <!-- 模式切换按钮区域 - 移至顶部 -->
    <view class="top-mode-toggle">
      <view class="mode-indicator">
        <text class="mode-label">当前模式:</text>
        <tui-tag 
          size="small" 
          padding="6px 10px" 
          type="gray" 
          @click="toggleVoiceInput"
        >
          <view class="toggle-mode">
            <tui-icon name="strategy" :size="16"></tui-icon>
            <text>文本对话</text>
          </view>
        </tui-tag>
      </view>
      <view class="mode-indicator">
        <tui-tag 
          size="small" 
          padding="6px 12px" 
          type="gray" 
          @click="openDrawer"
        >
          <view class="toggle-mode">
            <tui-icon name="tool" :size="16"></tui-icon>
            <text>{{isOpenAddtionalFunction ? '附加功能: ' + selectedFunction.text : '附加功能关闭'}}</text>
          </view>
        </tui-tag>
      </view>
    </view>

    <tui-drawer 
      mode="bottom" 
      :visible="visible" 
      @close="closeDrawer"
    >
      <view style="padding: 20px; background-color: white;">
        <view style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <text style="font-size: 18px; font-weight: bold;">选择附加功能</text>
          <view @tap="closeDrawer" style="padding: 5px;">
            <tui-icon name="close" :size="20" color="#666"></tui-icon>
          </view>
        </view>
        <view style="height: 1px; background-color: #eee; margin-bottom: 15px;"></view>
        <tui-cascade-selection 
          :reset="reset" 
          height="300px" 
          :itemList="functionList" 
          @complete="complete"
        ></tui-cascade-selection>
      </view>
    </tui-drawer>

    <!-- 聊天内容区域 -->
    <scroll-view 
      class="chat-content" 
      scroll-y 
      :scroll-top="scrollTop"
      scroll-with-animation
      @scrolltolower="loadMoreMessages"
      :style="{ height: contentHeight + 'px' }"
      :scroll-into-view="scrollToView"
    >
      <!-- 日期分割线 -->
      <view class="day-divider">{{currentDate}}</view>
      
      <!-- 消息列表 -->
      <block v-for="(message, index) in messageList" :key="index">
        <!-- AI消息 -->
        <view :id="'msg-' + index" class="message-container ai" v-if="message.type === 'ai'">
          <view class="message-row">
            <view class="message-avatar">
              <img alt="svgImg" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgNDggNDgiIHdpZHRoPSI0OHB4IiBoZWlnaHQ9IjQ4cHgiPjxwYXRoIGZpbGw9IiNmZmUwYjIiIGQ9Ik0yNiwxNmMtMTAuNzQ3LDAtMTkuODk5LDMuNC0yNS44NTYsNi4zNzVDMC4wNTEsMjMuMDczLDAsMjMuNzgyLDAsMjQuNUMwLDM1LjI3LDEwLjc0NSw0NCwyNCw0NAlzMjQtOC43MywyNC0xOS41YzAtMS4zNi0wLjE3Mi0yLjY4Ny0wLjQ5OS0zLjk2OUM0MC40NDYsMTcuNTMzLDMzLjIxNywxNiwyNiwxNnoiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMjQsMjMuNjE5Yy0wLjAxNSwzLjc2NywyLjk0OCw3LjIzOSw2LjU3OSw3LjM3NmMzLjU4OCwwLjEzNiw1LjkyOC0zLjA2Niw1LjMyNi02Ljc4NgljLTAuNTQ2LTMuMzctMy4zNjQtNi4wMjItNi4zNjctNi4yMDFDMjYuNTA2LDE3LjgyOSwyNC4wMTQsMjAuMjEzLDI0LDIzLjYxOXoiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMjQsMjMuNjE5YzAuMDE1LDMuNzY3LTIuOTQ0LDcuMjM5LTYuNTcxLDcuMzc2Yy0zLjU4MywwLjEzNi01LjkyMS0zLjA2Ni01LjMxOS02Ljc4NgljMC41NDUtMy4zNywzLjM1OS02LjAyMiw2LjM1OC02LjIwMUMyMS40OTgsMTcuODI5LDIzLjk4NiwyMC4yMTMsMjQsMjMuNjE5eiIvPjxjaXJjbGUgY3g9IjIxIiBjeT0iMjQiIHI9IjEiIGZpbGw9IiMyMTIxMjEiLz48Y2lyY2xlIGN4PSIyOCIgY3k9IjI0IiByPSIxIiBmaWxsPSIjMjEyMTIxIi8+PHBhdGggZmlsbD0iIzIxMjEyMSIgZD0iTTI0Ljc1NCw0MGMtMi43NSwwLTQuNzE5LTEuMTQ4LTQuODAyLTEuMTk3bDEuMDIxLTEuNzIxQzIwLjk4NSwzNy4wODksMjIuNTc1LDM4LDI0Ljc1NCwzOAljMS44MDUsMCwzLjI1My0wLjcyNCwzLjI2OC0wLjczMWwwLjkxMywxLjc4QzI4Ljg2LDM5LjA4NywyNy4wNjEsNDAsMjQuNzU0LDQweiIvPjxwYXRoIGZpbGw9IiMwMDk3YTciIGQ9Ik0wLjM2MSwyMS4xNTFjLTAuMDg2LDAuNDA0LTAuMTU3LDAuODExLTAuMjE0LDEuMjIzQzYuMTA0LDE5LjM5OSwxNS4yNTQsMTYsMjYsMTYJYzcuMjEsMCwxNC40MzMsMS41MzEsMjEuNDgzLDQuNTI0Yy0wLjExMi0wLjQxNi0wLjI0LTAuODI4LTAuMzc5LTEuMjM2Yy0wLjEwMi0wLjA0Mi0wLjIwNC0wLjA3Ni0wLjMwNS0wLjExNwljMC4yMDEsMC4wNjYsMC4zMjcsMC4xMDksMC4zMjcsMC4xMDlDNDQuMzE3LDExLjA0NiwzNS4wMjksNSwyNCw1QzEyLjE1MSw1LDIuMzEsMTEuOTc2LDAuMzU1LDIxLjE0OWMwLDAsMC4wODktMC4wNDIsMC4yNTQtMC4xMTUJQzAuNTI4LDIxLjA3MywwLjQ0MSwyMS4xMTIsMC4zNjEsMjEuMTUxeiIvPjxwYXRoIGZpbGw9IiNmZmVhMDAiIGQ9Ik00Ny43NTIsMjEuNzE1Yy0wLjE0Ni0wLjgyOS0wLjM3OC0xLjYzNS0wLjY0OC0yLjQyN0M0MC4xNzQsMTYuNDU0LDMzLjA4MywxNSwyNiwxNQljLTEwLjU0NCwwLTE5LjU3NywzLjIxMS0yNS42MzksNi4xNTFjLTAuMTY3LDAuNzg1LTAuMjg0LDEuNTg1LTAuMzMyLDIuMzk5QzYuNDEsMjAuMjgzLDE1LjQ0NiwxNywyNiwxNwlDMzQuNTYxLDE3LDQyLjAxNywxOS4yLDQ3Ljc1MiwyMS43MTV6Ii8+PHBvbHlnb24gZmlsbD0iI2ZmZWEwMCIgcG9pbnRzPSIxNiw2LjExIDE2LjgyNiw0LjQwOCAxOCw0IDIwLDMgMjMsMyAyNCwyIDI2LjA2MSwyLjM0NCAyNy41LDMuNSAyOS41LDQgMzAsNS42MTQgMjksNi41IDI3LDYgMjYsNyAyNC41LDcgMjMsNiAyMC41LDcgMjAsNS41IDE4LjUsNyAxNi41LDciLz48L3N2Zz4="/>
            </view>
            <view class="message message-ai" @touchstart="handleTouchStart" @touchend="handleTouchEnd">
              <!-- 文本消息 -->
              <text v-if="!message.isImage" class="ai-message-text">{{message.content}}</text>
              <!-- 图片消息 -->
              <view v-else class="ai-image-container">
                <image 
                  class="ai-generated-image" 
                  :src="message.content" 
                  mode="widthFix" 
                  @click="previewImage(message.content)" 
                  @longpress="saveImage(message.content)"
                />
                <view class="image-hint">点击可查看，长按可保存</view>
              </view>
              <tui-alert 
                :show="showModal" 
                size="30" 
                btnColor="#3b3b3b" 
                btnText="复制" 
                maskClosable="false" 
                @click="copyContent(message.content)" 
                @cancel="hideAlert"
                class="custom-alert"
              >
                <scroll-view class="alert-scroll-view" scroll-y>
                  <text class="alert-content">{{message.content}}</text>
                </scroll-view>
              </tui-alert>
            </view>
          </view>
          <view class="message-time">{{message.time}}</view>
        </view>
        
        <!-- 用户消息 -->
        <view :id="'msg-' + index" class="message-container user" v-else-if="message.type === 'user'">
          <view class="message-row">
            <view class="message-avatar">
              <text class="fa fa-user"></text>
            </view>
            <view class="message message-user">
              <text>{{message.content}}</text>
            </view>
          </view>
          <view class="message-time">{{message.time}}</view>
        </view>
      </block>
      
      <!-- AI思考中状态 -->
      <view class="message-container ai" v-if="isThinking" id="thinking-msg">
        <view class="message-row">
          <view class="message-avatar">
                    <img alt="svgImg" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciICB2aWV3Qm94PSIwIDAgNDggNDgiIHdpZHRoPSI0OHB4IiBoZWlnaHQ9IjQ4cHgiPjxwYXRoIGZpbGw9IiNmZmUwYjIiIGQ9Ik0yNiwxNmMtMTAuNzQ3LDAtMTkuODk5LDMuNC0yNS44NTYsNi4zNzVDMC4wNTEsMjMuMDczLDAsMjMuNzgyLDAsMjQuNUMwLDM1LjI3LDEwLjc0NSw0NCwyNCw0NAlzMjQtOC43MywyNC0xOS41YzAtMS4zNi0wLjE3Mi0yLjY4Ny0wLjQ5OS0zLjk2OUM0MC40NDYsMTcuNTMzLDMzLjIxNywxNiwyNiwxNnoiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMjQsMjMuNjE5Yy0wLjAxNSwzLjc2NywyLjk0OCw3LjIzOSw2LjU3OSw3LjM3NmMzLjU4OCwwLjEzNiw1LjkyOC0zLjA2Niw1LjMyNi02Ljc4NgljLTAuNTQ2LTMuMzctMy4zNjQtNi4wMjItNi4zNjctNi4yMDFDMjYuNTA2LDE3LjgyOSwyNC4wMTQsMjAuMjEzLDI0LDIzLjYxOXoiLz48cGF0aCBmaWxsPSIjZmZmIiBkPSJNMjQsMjMuNjE5YzAuMDE1LDMuNzY3LTIuOTQ0LDcuMjM5LTYuNTcxLDcuMzc2Yy0zLjU4MywwLjEzNi01LjkyMS0zLjA2Ni01LjMxOS02Ljc4NgljMC41NDUtMy4zNywzLjM1OS02LjAyMiw2LjM1OC02LjIwMUMyMS40OTgsMTcuODI5LDIzLjk4NiwyMC4yMTMsMjQsMjMuNjE5eiIvPjxjaXJjbGUgY3g9IjIxIiBjeT0iMjQiIHI9IjEiIGZpbGw9IiMyMTIxMjEiLz48Y2lyY2xlIGN4PSIyOCIgY3k9IjI0IiByPSIxIiBmaWxsPSIjMjEyMTIxIi8+PHBhdGggZmlsbD0iIzIxMjEyMSIgZD0iTTI0Ljc1NCw0MGMtMi43NSwwLTQuNzE5LTEuMTQ4LTQuODAyLTEuMTk3bDEuMDIxLTEuNzIxQzIwLjk4NSwzNy4wODksMjIuNTc1LDM4LDI0Ljc1NCwzOAljMS44MDUsMCwzLjI1My0wLjcyNCwzLjI2OC0wLjczMWwwLjkxMywxLjc4QzI4Ljg2LDM5LjA4NywyNy4wNjEsNDAsMjQuNzU0LDQweiIvPjxwYXRoIGZpbGw9IiMwMDk3YTciIGQ9Ik0wLjM2MSwyMS4xNTFjLTAuMDg2LDAuNDA0LTAuMTU3LDAuODExLTAuMjE0LDEuMjIzQzYuMTA0LDE5LjM5OSwxNS4yNTQsMTYsMjYsMTYJYzcuMjEsMCwxNC40MzMsMS41MzEsMjEuNDgzLDQuNTI0Yy0wLjExMi0wLjQxNi0wLjI0LTAuODI4LTAuMzc5LTEuMjM2Yy0wLjEwMi0wLjA0Mi0wLjIwNC0wLjA3Ni0wLjMwNS0wLjExNwljMC4yMDEsMC4wNjYsMC4zMjcsMC4xMDksMC4zMjcsMC4xMDlDNDQuMzE3LDExLjA0NiwzNS4wMjksNSwyNCw1QzEyLjE1MSw1LDIuMzEsMTEuOTc2LDAuMzU1LDIxLjE0OWMwLDAsMC4wODktMC4wNDIsMC4yNTQtMC4xMTUJQzAuNTI4LDIxLjA3MywwLjQ0MSwyMS4xMTIsMC4zNjEsMjEuMTUxeiIvPjxwYXRoIGZpbGw9IiNmZmVhMDAiIGQ9Ik00Ny43NTIsMjEuNzE1Yy0wLjE0Ni0wLjgyOS0wLjM3OC0xLjYzNS0wLjY0OC0yLjQyN0M0MC4xNzQsMTYuNDU0LDMzLjA4MywxNSwyNiwxNQljLTEwLjU0NCwwLTE5LjU3NywzLjIxMS0yNS42MzksNi4xNTFjLTAuMTY3LDAuNzg1LTAuMjg0LDEuNTg1LTAuMzMyLDIuMzk5QzYuNDEsMjAuMjgzLDE1LjQ0NiwxNywyNiwxNwlDMzQuNTYxLDE3LDQyLjAxNywxOS4yLDQ3Ljc1MiwyMS43MTV6Ii8+PHBvbHlnb24gZmlsbD0iI2ZmZWEwMCIgcG9pbnRzPSIxNiw2LjExIDE2LjgyNiw0LjQwOCAxOCw0IDIwLDMgMjMsMyAyNCwyIDI2LjA2MSwyLjM0NCAyNy41LDMuNSAyOS41LDQgMzAsNS42MTQgMjksNi41IDI3LDYgMjYsNyAyNC41LDcgMjMsNiAyMC41LDcgMjAsNS41IDE4LjUsNyAxNi41LDciLz48L3N2Zz4="/>
          </view>
          <view class="message message-ai thinking">
            <text>正在思考</text>
            <view class="loading-dots">
              <view class="dot"></view>
              <view class="dot"></view>
              <view class="dot"></view>
            </view>
          </view>
        </view>
        <view class="message-time">{{currentTime}}</view>
      </view>
      
      <!-- 底部安全区域 - 防止内容被底部输入栏遮挡 -->
      <view class="safe-bottom-area"></view>
    </scroll-view>
    
    <!-- 底部输入区域 -->
    <view 
      class="chat-bottom" 
      :class="{'keyboard-active': isKeyboardShow}"
      :style="{ transform: isKeyboardShow ? 'translateY(-' + keyboardHeight + 'px)' : 'translateY(0)' }"
    >
      <!-- 提示词区域 -->
      <view class="suggestion-area" v-show="showSuggestions">
        <view class="suggestion-title">你可以这样问我</view>
        <view class="suggestion-chips">
          <view 
            class="suggestion-chip" 
            v-for="(suggestion, idx) in suggestions" 
            :key="idx"
            @tap="useSuggestion(suggestion)"
          >
            {{suggestion}}
          </view>
        </view>
        <view class="ai-intro">
          <text class="intro-title">友情提示：</text>
          <text class="intro-content">我是一个智能AI助手，可以回答问题、提供信息、写作、规划行程、提供建议等。我会不断学习和改进，为您提供更好的服务体验。请注意，我偶尔可能会出现错误，对于专业领域的问题请谨慎参考。</text>
        </view>
      </view>
      
      <!-- 输入框区域 -->
      <view class="chat-input-area">
        <!-- 附加功能提示区域 -->
        <view v-if="isOpenAddtionalFunction && selectedFunction.text" 
              class="function-tip-area"
              :class="{
                'translate-tip': selectedFunction.text === '中译英' || selectedFunction.text === '英译中',
                'review-tip': selectedFunction.text && selectedFunction.text.includes('评价'),
                'other-tip': !(selectedFunction.text === '中译英' || selectedFunction.text === '英译中') && !selectedFunction.text.includes('评价')
              }">
          <view class="function-tip-content">
            <tui-icon :name="getFunctionIcon(selectedFunction.text)" color="#4A90E2" :size="18"></tui-icon>
            <text class="function-tip-text">
              <template v-if="selectedFunction.text === '中译英'">请输入需要翻译的中文内容</template>
              <template v-else-if="selectedFunction.text === '英译中'">请输入需要翻译的英文内容</template>
              <template v-else-if="selectedFunction.text && selectedFunction.text.includes('好评')">
                请输入需要生成{{selectedFunction.value}}好评的事物关键词：如面条、火锅、鞋子、酒店等
              </template>
              <template v-else-if="selectedFunction.text && selectedFunction.text.includes('差评')">
                请输入需要生成{{selectedFunction.value}}差评的事物关键词：如面条、火锅、鞋子、酒店等
              </template>
              <template v-else>已启用{{selectedFunction.text}}功能</template>
            </text>
          </view>
        </view>
        
        <!-- 输入框和发送按钮区域 -->
        <view class="input-send-area">
          <textarea 
            class="chat-input" 
            v-model="inputMessage" 
            placeholder="输入消息..." 
            :auto-height="true"
            :cursor-spacing="8"
            :show-confirm-bar="false"
            :adjust-position="false"
            @input="adjustInputHeight"
            @focus="onInputFocus"
            @blur="onInputBlur"
            @keyboardheightchange="onKeyboardHeightChange"
            :maxlength="-1"
            confirm-type="return"
            :confirm-hold="true"
          />
          <view class="send-btn-area">
            <view class="chat-btn send-btn" @tap="sendMessage" :class="{'btn-active': inputMessage.trim().length > 0}">
              <tui-icon name="send" :color="inputMessage.trim().length > 0 ? '#4A90E2' : '#999"></tui-icon>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 录音中提示框 -->
    <!-- <view class="recording-hint" v-if="isText2Pic">
      正在录音...
    </view> -->
  </view>
</template>

<script>
import { checkLoginStatus } from '@/utils/auth'
import request from '@/utils/request'
import envConfig from '@/utils/env-config'

export default {
  data() {
    return {
      messageList: [],
      inputMessage: '',
      scrollTop: 0,
      scrollToView: '',
      contentHeight: 500, // 会在onLoad中计算
      showSuggestions: true,
      isThinking: false,
      isText2Pic: false,
      isKeyboardShow: false,
      keyboardHeight: 0,
      baseUrl: '',
      // 当前日期和时间
      currentDate: '今天 ' + this.formatTime(new Date()),
      currentTime: this.formatTime(new Date()),
      visible:false,
      // 示例提示词
      suggestions: [
        '帮我写一封邮件',
        '如何提高英语口语水平？',
        '今天北京天气怎么样？',
        '帮我规划一次旅行',
        '你能做什么？'
      ],
      
      // 用户信息
      userInfo: {
        nickName: '游客',
        avatar: '',
        openid: 'guest_' + Math.random().toString(36).substr(2, 10)
      },
      
      // 底部输入区域高度
      bottomHeight: 130,

      lastTapTime: 0,
      showModal: false,
      // 附加功能列表
      functionList: [],
      // 附加功能是否开启
      isOpenAddtionalFunction: false,
      // 重置
      reset: 0,
      // 存储用户选择的附加功能
      selectedFunction: {
        text: '',
        value: ''
      },
    };
  },
  
  onLoad() {
    this.functionList = [
      {
        text: '翻译',
        children: [
          { text: '中译英' ,value:'中译英'},
          { text: '英译中' ,value:'英译中'},
        ]
      },
      {
        text: '评价',
        children: [
          { text: '好评' ,value:'好评',children:[{text:'二十字',value:'二十字'},{text:'三十字',value:'三十字'},{text:'四十字',value:'四十字'}]},
          { text: '差评' ,value:'差评',children:[{text:'二十字',value:'二十字'},{text:'三十字',value:'三十字'},{text:'四十字',value:'四十字'}]},
        ]
      },
     
    ];
    // 从环境配置中获取API基础URL
    this.baseUrl = envConfig.API_BASE_URL;
    console.log('从配置文件加载API基础URL:', this.baseUrl);
    
    // 如果配置中没有找到，则尝试从App全局变量获取
    if (!this.baseUrl) {
      const app = getApp();
      this.baseUrl = app.globalData.apiBaseUrl;
      console.log('从App全局变量获取API基础URL:', this.baseUrl);
    }
    
    // 确保baseUrl有值，设置最终的默认值
    if (!this.baseUrl) {
      this.baseUrl = 'http://localhost:8000';
      console.warn('API基础URL未在配置中找到，使用默认值:', this.baseUrl);
    }
    
    // 检查登录状态
    this.checkLoginStatus();
    
    // 获取预设问题
    const app = getApp();
    const globalData = app.globalData;
    if (globalData && globalData.presetQuestion) {
      // 设置输入内容
      this.inputMessage = globalData.presetQuestion;
      // 自动发送消息
      this.$nextTick(() => {
        this.sendMessage();
      });
      // 清除预设问题
      globalData.presetQuestion = '';
    }

    // 检查用户信息，如果没有则使用默认值
    try {
      const userInfoData = uni.getStorageSync('userInfo');
      if (userInfoData) {
        // 检查是否需要解析
        if (typeof userInfoData === 'string') {
          try {
            this.userInfo = JSON.parse(userInfoData);
          } catch (e) {
            console.error('解析用户信息字符串失败', e);
            this.userInfo = {
              nickName: '游客',
              avatar: '',
              openid: 'guest_' + Math.random().toString(36).substr(2, 10)
            };
          }
        } else {
          // 已经是对象，直接使用
          this.userInfo = userInfoData;
        }
      } else {
        // 未登录用户使用默认信息
        this.userInfo = {
          nickName: '游客',
          avatar: '',
          openid: 'guest_' + Math.random().toString(36).substr(2, 10)
        };
        console.log('用户未登录，使用游客模式');
      }
    } catch (e) {
      console.error('获取用户信息失败', e);
      // 使用默认用户信息
      this.userInfo = {
        nickName: '游客',
        avatar: '',
        openid: 'guest_' + Math.random().toString(36).substr(2, 10)
      };
    }
    
    // 计算内容区域高度
    const systemInfo = uni.getSystemInfoSync();
    // 计算底部输入区域的高度
    const query = uni.createSelectorQuery().in(this);
    
    // 延迟计算以确保DOM已渲染
    setTimeout(() => {
      query.select('.chat-bottom').boundingClientRect();
      query.select('.chat-header').boundingClientRect();
      query.select('.top-mode-toggle').boundingClientRect();
      query.exec(res => {
        if (res && res[0] && res[1] && res[2]) {
          this.bottomHeight = res[0].height || 130;
          const headerHeight = res[1].height || 50;
          const modeToggleHeight = res[2].height || 40;
          
          // 计算内容区域高度 = 屏幕高度 - 导航栏高度 - 模式切换区域高度 - 底部输入区域高度
          this.contentHeight = systemInfo.windowHeight - headerHeight - modeToggleHeight - this.bottomHeight;
          console.log('计算高度：', this.contentHeight, '底部高度：', this.bottomHeight, 
                      '顶部高度：', headerHeight, '模式切换高度：', modeToggleHeight);
        } else {
          // 如果获取失败，使用默认值
          this.contentHeight = systemInfo.windowHeight - 220; // 默认值调整
        }
      });
    }, 100);
    
    // 初始化示例消息
    this.initMessages();
  },
  
  onReady() {
    // 页面加载完成后，滚动到底部
    this.scrollToBottom();
  },
  
  // 每次页面显示时检查登录状态
  onShow() {
    // 检查登录状态
    this.checkLoginStatus();
  },
  
  methods: {
    complete(e) {
  		console.log(e);
  		console.log('您选择的数据为：' + e.text)
      this.isOpenAddtionalFunction = true;
      // 存储用户选择的附加功能数据
      this.selectedFunction = {
        text: e.text,
        value: e.value
      };
      uni.showToast({
        title: '附加功能已开启: ' + e.text,
        icon: 'none',
        duration: 2000
      });
      this.visible = false
      this.reset = 1
  	},
    closeDrawer(e) {

  		this.visible = false
      this.reset = 1
  	},
  	//调用此方法显示抽屉
  	openDrawer() {
      if(this.isOpenAddtionalFunction){
        this.isOpenAddtionalFunction = false;
        this.reset = 1
        // 清空选中的功能数据
        this.selectedFunction = {
          text: '',
          value: ''
        };
        uni.showToast({
          title: '附加功能已关闭',
          icon: 'none',
          duration: 2000
        });
      }else{
        this.visible = true
        this.reset = 1
      }
  		
  	},
    // 检查登录状态
    checkLoginStatus() {
      // 使用工具函数检查登录状态
      const isLoggedIn = checkLoginStatus();
      
      if (!isLoggedIn) {
        uni.showToast({
          title: '登录已过期，请重新登录',
          icon: 'none',
          duration: 2000
        });
        
        // 延迟跳转到登录页面
        setTimeout(() => {
          uni.redirectTo({
            url: '/pages/index/index'
          });
        }, 2000);
      }
    },
  	hideAlert() {
 		this.showModal = false
 	  },
    handleTouchStart(e) {
      const currentTime = new Date().getTime();
      const timeDiff = currentTime - this.lastTapTime;
      if (timeDiff < 300 && timeDiff > 0) {
        this.showModal = true;
      }
      this.lastTapTime = currentTime;
    },
    handleTouchEnd() {
      // 这里可以处理手势结束，如果有需要
    },
    copyContent(message) {
      uni.setClipboardData({
        data: message,
        success: () => {
          uni.showToast({
            title: '复制成功',
            icon: 'success'
          });
          this.showModal = false;
        }
      });
    },

    /**
     * 监听键盘高度变化
     */
    onKeyboardHeightChange(e) {
      const height = e.detail.height;
      console.log('键盘高度变化：', height);
      
      if (height > 0) {
        // 键盘弹出
        this.keyboardHeight = height;
        this.isKeyboardShow = true;
      } else {
        // 键盘收起
        this.isKeyboardShow = false;
      }
      
      // 滚动到底部
      this.$nextTick(() => {
        this.scrollToBottom();
      });
    },
    
    /**
     * 输入框获取焦点
     */
    onInputFocus() {
      this.showSuggestions = false;
      
      // 滚动到底部，延迟执行确保在键盘弹出后滚动
      setTimeout(() => {
        this.scrollToBottom();
      }, 300);
    },
    
    /**
     * 输入框失去焦点
     */
    onInputBlur() {
      // 当键盘收起时，延迟一点时间再重置，防止闪烁
      setTimeout(() => {
        this.isKeyboardShow = false;
        
        if (this.messageList.length <= 1 && !this.inputMessage) {
          this.showSuggestions = true;
        }
      }, 100);
    },
    
    /**
     * 初始化示例聊天消息
     */
    initMessages() {
      const now = new Date();
      const timeStr = this.formatTime(now);
      
      this.messageList = [
        {
          type: 'ai',
          content: '你好！我是你的AI聊天助手，有什么我可以帮助你的吗？',
          time: timeStr
        }
      ];
    },
    
    /**
     * 发送消息
     */
    sendMessage() {

      if (!this.inputMessage.trim()) return;
      
      // 获取当前时间
      const now = new Date();
      const timeStr = this.formatTime(now);
      
      // 拼接消息内容
      let userMessageContent = this.inputMessage;
      
      // 如果开启了附加功能，在用户UI消息中标注
      if (this.isOpenAddtionalFunction && this.selectedFunction.text) {
        userMessageContent = `${this.inputMessage} [${this.selectedFunction.text}]`;
      }
      
      // 添加用户消息
      this.messageList.push({
        type: 'user',
        content: userMessageContent,
        time: timeStr
      });
      
      // 清空输入框
      const message = this.inputMessage;
      this.inputMessage = '';
      
      // 显示思考状态
      this.isThinking = true;
      this.showSuggestions = false;
      
      // 滚动到底部
      this.$nextTick(() => {
        // 设置滚动到思考消息
        this.scrollToView = 'thinking-msg';
        
        // 300ms后再次尝试滚动
        setTimeout(() => {
          this.scrollToBottom();
        }, 300);
      });
      
      // 调用AI响应函数
      if(!this.isText2Pic){
        // 调用AI生成文字方法
        this.getAiResponse(message).then(response => {
        
        // 添加AI回复
        this.messageList.push({
          type: 'ai',
          content: response,
          isImage: false,
          time: this.formatTime(new Date())
        });
        
        // 滚动到底部
        this.$nextTick(() => {
          // 设置滚动到最新消息
          this.scrollToView = 'msg-' + (this.messageList.length - 1);
          
          // 额外的滚动保障
          setTimeout(() => {
            this.scrollToBottom();
          }, 300);
          
          setTimeout(() => {
            this.scrollToBottom();
          }, 600);
        });
      }).catch(error => {
        this.isThinking = false;
        console.error('AI响应错误:', error);
        
        // 添加错误消息
        this.messageList.push({
          type: 'ai',
          content: '抱歉，出现了一些问题，请稍后再试。',
          isImage: false,
          time: this.formatTime(new Date())
        });
        
        // 滚动到底部
        this.$nextTick(() => {
          this.scrollToBottom();
        });
      }).finally(() => {
        this.isThinking = false;
      });
      }else{
        // 调用文生图方法
        this.getText2ImageResponse(message).then(response => {
          console.log('文生图AI响应:', response);
          
          try {
            // 解析响应数据以获取图片URL
            let imageUrl = '';
            
            if (response && response.result) {
              // 解析嵌套的JSON字符串
              let resultData = response.result;
              
              // 如果resultData已经是对象(前面的优化已经解析过JSON)，则直接使用
              if (typeof resultData === 'object') {
                console.log('已解析的图片数据:', resultData);
              } else if (typeof resultData === 'string') {
                // 仍需要解析字符串
                resultData = JSON.parse(resultData);
                console.log('解析后的图片数据:', resultData);
              }
              
              if (resultData.success && resultData.data && resultData.data.length > 0) {
                imageUrl = resultData.data[0].image_url;
                console.log('获取到的图片URL:', imageUrl);
              }
            }
            
            if (imageUrl) {
              // 添加AI回复-图片消息
              this.messageList.push({
                type: 'ai',
                content: imageUrl,
                isImage: true,
                time: this.formatTime(new Date())
              });
            } else {
              // 如果未找到图片URL，显示错误消息
              this.messageList.push({
                type: 'ai',
                content: '抱歉，图片生成失败，无法获取图片URL。请尝试调整您的描述再试。',
                isImage: false,
                time: this.formatTime(new Date())
              });
            }
          } catch (e) {
            console.error('处理图片响应出错:', e, '原始响应:', response);
            this.messageList.push({
              type: 'ai',
              content: '抱歉，处理图片响应时出错，请稍后再试。错误信息：' + e.message,
              isImage: false,
              time: this.formatTime(new Date())
            });
          }
          
          // 滚动到底部
          this.$nextTick(() => {
            this.scrollToView = 'msg-' + (this.messageList.length - 1);
            setTimeout(() => {
              this.scrollToBottom();
            }, 300);
          });
        }).catch(error => {
          this.isThinking = false;
          console.error('文生图AI响应错误:', error);
          
          // 添加更具体的错误提示
          let errorMessage = '抱歉，图片生成失败，请稍后再试。';
          
          if (error && error.message) {
            if (error.message.includes('timeout') || error.message.includes('超时')) {
              errorMessage = '图片生成超时，请尝试简化您的描述或稍后再试。';
            } else if (error.message.includes('网络请求失败')) {
              errorMessage = '网络连接不稳定，请检查您的网络后再试。';
            }
          }
          
          this.messageList.push({
            type: 'ai',
            content: errorMessage,
            isImage: false,
            time: this.formatTime(new Date())
          });
          
          // 滚动到底部
          this.$nextTick(() => {
            this.scrollToBottom();
          });
        }).finally(() => {
          this.isThinking = false;
        });
      }
    },
    
    /**
     * AI的响应生成函数
     */
    getAiResponse(userMessage) {
        // 返回一个 Promise 对象
        return new Promise((resolve, reject) => {
          console.log('请求AI回复，使用配置的baseUrl:', this.baseUrl);
          
          // 准备请求参数，根据是否启用附加功能决定发送内容
          let requestData = { message: userMessage };
          
          // 如果开启了附加功能，将功能信息加入请求
          if (this.isOpenAddtionalFunction && this.selectedFunction.text) {
            requestData = {
              message: userMessage,
              functionType: this.selectedFunction.text,
              functionValue: this.selectedFunction.value
            };
            console.log('附加功能已启用，发送附加数据:', this.selectedFunction);
          }
          
          request.get('/chat/chatAi', requestData, {
            
            loading: false, // 不显示loading，因为我们有自己的加载状态
            timeout: 120000, // 设置2分钟超时时间
            maxRetries: 2,   // 设置最多重试2次
            header: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          }).then(response => {
            console.log('AI响应数据:', response);
            resolve(response);
          }).catch(error => {
            console.error('AI请求失败:', error);
            
            // 针对不同错误类型返回不同的友好消息
            let errorMsg = '抱歉，我现在无法回答您的问题。';
            
            if (error && error.message) {
              if (error.message.includes('timeout') || error.message.includes('超时')) {
                errorMsg = '回答您的问题需要较长时间，请尝试简化您的问题或稍后再试。';
              } else if (error.message.includes('网络请求失败')) {
                errorMsg = '网络连接不稳定，请检查您的网络后再试。';
              } else if (error.code === 500) {
                errorMsg = '服务器内部错误，请稍后再试。';
              }
            }
            
            resolve(errorMsg);
          });
        });
    },

    /*
     * 调用后端文生图api
     */
    getText2ImageResponse(userMessage) {
      return new Promise((resolve, reject) => {
        console.log('请求生成图片，使用配置的baseUrl:', this.baseUrl);
        
        // 定义重试相关参数
        const maxRetries = 3;
        let retryCount = 0;
        
        // 创建一个发送请求的函数以支持重试
        const sendRequest = () => {
          console.log(`正在尝试请求，第 ${retryCount + 1} 次尝试, 消息内容: ${userMessage.slice(0, 50)}...`);
          
          // 使用原生uni.request替代封装的request工具，以获取更多控制
          uni.request({
            url: this.baseUrl + '/chat/text2imagewithdeepseek',
            method: 'GET',
            data: { message: userMessage },
            header: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            timeout: 120000, // 2分钟超时
            success: (res) => {
              console.log('API请求成功，状态码:', res.statusCode);
              console.log('API响应头:', res.header);
              
              if (res.statusCode === 200) {
                console.log('图片生成成功，响应数据长度:', typeof res.data === 'string' ? res.data.length : JSON.stringify(res.data).length);
                try {
                  let resultData = res.data;
                  
                  // 尝试解析响应数据
                  if (typeof resultData === 'string') {
                    resultData = JSON.parse(resultData);
                  }
                  
                  // 如果resultData中有result字段且为字符串，再次尝试解析
                  if (resultData.result && typeof resultData.result === 'string') {
                    try {
                      resultData.result = JSON.parse(resultData.result);
                    } catch (err) {
                      console.log('内层数据解析失败，保持原样:', err);
                    }
                  }
                  
                  resolve(resultData);
                } catch (parseErr) {
                  console.error('响应数据解析失败:', parseErr);
                  // 即使解析失败，仍然返回原始数据
                  resolve(res.data);
                }
              } else {
                console.error(`API请求状态码错误: ${res.statusCode}`);
                
                // 如果状态码非200但仍有数据，尝试解析和使用
                if (res.data) {
                  try {
                    let errorData = res.data;
                    if (typeof errorData === 'string') {
                      errorData = JSON.parse(errorData);
                    }
                    console.log('错误响应内容:', errorData);
                    reject(errorData);
                  } catch (e) {
                    reject({
                      code: res.statusCode,
                      message: `服务器返回错误: ${res.statusCode}`,
                      data: res.data
                    });
                  }
                } else {
                  reject({
                    code: res.statusCode,
                    message: `服务器返回错误: ${res.statusCode}`,
                    data: null
                  });
                }
              }
            },
            fail: (err) => {
              console.error('API请求失败, 详细信息:', err);
              
              // 处理重试逻辑
              if (retryCount < maxRetries) {
                retryCount++;
                console.log(`请求失败，正在进行第 ${retryCount} 次重试...`);
                
                // 延迟重试，避免连续快速请求
                setTimeout(() => {
                  sendRequest();
                }, 2000); // 2秒后重试
              } else {
                console.error(`已达到最大重试次数 ${maxRetries}，放弃请求`);
                
                // 判断是否是超时
                const isTimeout = err.errMsg && (
                  err.errMsg.includes('timeout') || 
                  err.errMsg.includes('超时')
                );
                
                reject({
                  code: isTimeout ? 408 : err.statusCode || -1,
                  message: isTimeout ? 
                    '图片生成超时，请尝试简化您的描述或稍后再试' : 
                    (err.errMsg || '网络请求失败'),
                  data: err
                });
              }
            },
            complete: () => {
              console.log(`第 ${retryCount + 1} 次请求完成`);
            }
          });
        };
        
        // 开始第一次请求
        sendRequest();
      });
    },
      
     
    /**
     * 将时间格式化为 HH:MM 格式
     */
    formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    },
    
    /**
     * 滚动到聊天底部
     */
    scrollToBottom() {
      // 计算滚动区域的高度
      const query = uni.createSelectorQuery().in(this);
      query.select('.chat-content').boundingClientRect();
      query.exec(res => {
        if (res && res[0]) {
          // 设置滚动到最新消息，并预留底部空间
          this.scrollTop = 100000;
          
          // 设置滚动到最新消息，并预留底部空间
          if (this.messageList.length > 0) {
            this.scrollToView = 'msg-' + (this.messageList.length - 1);
          }
          
          // 强制更新DOM
          this.$forceUpdate();
        }
      });
    },
    
    /**
     * 加载更多历史消息（上拉加载）
     */
    loadMoreMessages() {
      // 真实场景中，这里会调用API加载更多历史消息
      console.log('加载更多历史消息');
    },
    
    /**
     * 使用提示词
     */
    useSuggestion(suggestion) {
      this.inputMessage = suggestion;
      this.sendMessage();
    },
    
    /**
     * 调整输入框高度
     */
    adjustInputHeight(e) {
      // 输入框高度自适应
    },
    
    /**
     * 切换语音输入
     */
    toggleVoiceInput() {
      this.isText2Pic = !this.isText2Pic;
      
      if (this.isText2Pic) {
        uni.showToast({
          title: '已切换到图片生成模式',
          icon: 'none',
          duration: 1500
        });
      } else {
        uni.showToast({
          title: '已切换到文字生成模式',
          icon: 'none',
          duration: 1500
        });
      }
    },
    
    /**
     * 跳转到设置页面
     */
    goToSettings() {
      uni.navigateTo({
        url: '/pages/settings/settings'
      });
    },
    
    /**
     * 返回上一页
     */
    goBack() {
      uni.navigateBack({
        delta: 1
      });
    },
    
    /**
     * 预览图片
     */
    previewImage(url) {
      uni.previewImage({
        urls: [url],
        current: url,
        indicator: 'number',
        loop: false
      });
    },
    
    /**
     * 保存图片
     */
    saveImage(url) {
      uni.showLoading({
        title: '保存中...'
      });
      
      // 下载图片
      uni.downloadFile({
        url: url,
        success: (res) => {
          if (res.statusCode === 200) {
            // 保存图片到相册
            uni.saveImageToPhotosAlbum({
              filePath: res.tempFilePath,
              success: () => {
                uni.showToast({
                  title: '保存成功',
                  icon: 'success'
                });
              },
              fail: (err) => {
                console.error('保存图片失败', err);
                uni.showToast({
                  title: '保存失败',
                  icon: 'none'
                });
              }
            });
          } else {
            uni.showToast({
              title: '下载失败',
              icon: 'none'
            });
          }
        },
        fail: (err) => {
          console.error('下载图片失败', err);
          uni.showToast({
            title: '下载失败',
            icon: 'none'
          });
        },
        complete: () => {
          uni.hideLoading();
        }
      });
    },

    /**
     * 根据功能类型获取对应的图标
     */
    getFunctionIcon(functionType) {
      if (functionType === '中译英' || functionType === '英译中') {
        return 'exchange';
      } else if (functionType && functionType.includes('评价')) {
        return 'star';
      } else {
        return 'tip';
      }
    },

    /**
     * 根据功能类型获取对应的颜色
     */
    getFunctionColor(functionType) {
      if (functionType === '中译英' || functionType === '英译中') {
        return '#4A90E2'; // 蓝色
      } else if (functionType && functionType.includes('评价')) {
        return '#FF9500'; // 橙色
      } else {
        return '#5cb85c'; // 绿色
      }
    },
  }
};
</script>

<style scoped>
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: relative;
  background-color: var(--light-gray);
  overflow: hidden; /* 防止内容溢出 */
}

/* 顶部导航栏 */
.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-md) var(--spacing-lg);
  background-color: var(--primary-color);
  color: white;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  left: 0;
  right: 0;
  z-index: 10;
  height: 30px;
}

.back-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--primary-color);
  transition: all 0.2s ease;
}

.back-btn:active {
  background-color: rgba(255, 255, 255, 0.3);
}

.chat-title {
  font-size: var(--font-size-lg);
  font-weight: 600;
}

.chat-settings {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--primary-color);
  transition: all 0.2s ease;
}

.chat-settings:active {
  background-color: rgba(255, 255, 255, 0.3);
}

/* 聊天内容区域 */
.chat-content {
  flex: 1;
  background-color: var(--light-gray);
  overflow-y: scroll;
  -webkit-overflow-scrolling: touch;
  position: relative;
  padding-bottom: 70px; /* 增加底部padding，确保消息不被底部输入区域遮挡 */
}

.day-divider {
  text-align: center;
  color: var(--text-light);
  font-size: var(--font-size-xs);
  margin: var(--spacing-lg) 0;
  position: relative;
}

.day-divider::before,
.day-divider::after {
  content: "";
  position: absolute;
  height: 1px;
  background-color: var(--border-color);
  top: 50%;
  width: calc(50% - 50px);
}

.day-divider::before {
  left: 0;
}

.day-divider::after {
  right: 0;
}
.tui-alert-mask {
  background-color: rgba(0, 0, 0, 0.1);
}
/* 消息容器 */
.message-container {
  display: flex;
  flex-direction: column;
  margin-bottom: var(--spacing-lg);
  max-width: 95%;
  width: 100%; /* 确保容器有足够宽度 */
  padding-bottom: 5px; /* 添加底部间距 */
}

.message-container.ai {
  align-items: flex-start;
  margin-right: auto;
}

.message-container.user {
  align-items: flex-end;
  margin-left: auto;
}

.message-row {
  display: flex;
  align-items: flex-start; /* 改为从顶部对齐 */
  gap: var(--spacing-sm);
  width: 100%; /* 确保行宽度充足 */
  position: relative; /* 添加相对定位 */
  margin-bottom: 4px; /* 增加消息行间距 */
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  background-color: var(--light-gray);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-light);
  z-index: 1; /* 确保在其他元素上方 */
  position: relative; /* 添加相对定位 */
}

.message-container.user .message-row {
  flex-direction: row-reverse;
}

.message-container.user .message-avatar {
  background-color: var(--primary-color);
}

.message-container.user .message-avatar text {
  color: white;
}

.message {
  max-width: 66%;
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--border-radius-lg);
  position: relative;
  word-break: break-word;
  font-size: var(--font-size-md);
  line-height: 1.5;
  box-shadow: 8px 8px 8px 0 rgba(0, 0, 0, 0.08), -8px -8px 12px 0 rgba(255, 255, 255, 0.3);
  margin-top: 0; /* 确保没有顶部边距 */
}

.message-time {
  font-size: var(--font-size-xs);
  color: var(--text-light);
  margin: var(--spacing-xs) var(--spacing-sm);
  line-height: 1;
  clear: both; /* 确保时间显示不受浮动影响 */
  border: 1px;
}

.message-ai {
  background-color: white;
  border-bottom-left-radius: 4px;
  color: var(--text-color);
  padding: 12px 16px;
  word-break: break-word;
  white-space: pre-wrap;
  max-width: 100%;
  overflow-wrap: break-word;
}

/* Markdown内容样式调整 */
.message-ai :deep(.markdown-content) {
  min-width: 100%;
  font-size: var(--font-size-md);
  line-height: 1.5;
}

/* 代码块样式增强 */
.message-ai :deep(.md-pre) {
  margin: 10rpx 0;
  border-radius: 8rpx;
}

/* 表格样式优化 */
.message-ai :deep(.md-table) {
  max-width: 100%;
  overflow-x: auto;
}

/* 列表样式增强 */
.message-ai :deep(.md-ul), .message-ai :deep(.md-ol) {
  padding-left: 20rpx;
}

.message-user {
  background-color: var(--primary-color);
  color: white;
  border-bottom-right-radius: 4px;
  padding: 12px 16px;
  word-break: break-word;
  white-space: pre-wrap;
  max-width: 100%;
  overflow-wrap: break-word;
}

/* 底部输入区域 */
.chat-bottom {
  background-color: white;
  border-top: 1px solid var(--border-color);
  position: fixed; /* 固定定位 */
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 100; /* 确保在最上层 */
  width: 100%;
  transform: translateY(0); /* 初始位置 */
  transition: transform 0.25s ease-out; /* 控制动画时间和曲线，使其更贴近键盘动画 */
  will-change: transform; /* 优化性能 */
  padding-bottom: env(safe-area-inset-bottom, 0px); /* 适配安全区 */
  box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.05); /* 添加微妙阴影 */
}

/* 键盘激活时的样式 */
.chat-bottom.keyboard-active {
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); /* 添加阴影效果，增强视觉分离 */
  background-color: #fafafa; /* 轻微改变背景色 */
}

.chat-input-area {
  padding: 8px;
  display: flex;
  flex-direction: column;
  position: relative;
  gap: 10px;
  max-width: 960px; /* 设置最大宽度，让在大屏上的显示更好 */
  margin: 0 auto; /* 居中显示 */
  background-color: #fff;
  border-radius: 10px;
  z-index: 101;
}

/* 模式切换区域 */
.top-mode-toggle {
  padding: 8px 10px;
  background-color: #f9f9f9;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  align-items: center;
  gap: 8px;
  z-index: 5;
}

.mode-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.mode-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  white-space: nowrap;
}

.mode-indicator-function {
  margin-left: 10px;
}

@media screen and (max-width: 375px) {
  .top-mode-toggle {
    padding: 8px 6px;
    gap: 6px;
  }
  
  .mode-indicator, .mode-indicator-function {
    margin-left: 0;
    gap: 4px;
  }
  
  .mode-label {
    font-size: 10px;
  }
  
  .function-status-text {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
}

/* 输入框和发送按钮区域 */
.input-send-area {
  display: flex;
  flex-direction: row;
  align-items: flex-end;
  position: relative;
  border: 1px solid var(--border-color);
  border-radius: 18px; /* 增加圆角使其更加圆润 */
  background-color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  overflow: hidden; /* 防止内容溢出圆角 */
  margin: 0 2px; /* 增加两侧边距 */
}

.input-send-area:focus-within {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-focus);
}

.chat-input {
  flex: 1;
  border: none;
  border-radius: var(--border-radius-lg);
  padding: 12px 16px; /* 固定内边距，确保一致性 */
  padding-right: 50px; /* 为发送按钮留出空间 */
  font-size: var(--font-size-md);
  background-color: transparent;
  min-height: 44px;
  max-height: 120px;
  outline: none;
  width: 100%;
  box-sizing: border-box;
  line-height: 1.5; /* 增加行高，让多行文本间距更合理 */
}

/* 发送按钮区域 */
.send-btn-area {
  position: absolute;
  right: 8px; /* 调整右侧边距 */
  bottom: 3px; /* 调整底部边距 */
}

.chat-btn.send-btn {
  width: 38px;
  height: 38px;
  background-color: #ffffff;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s ease-in-out;
}

.chat-btn.send-btn.btn-active {
  transform: scale(1.05);
}

.recording-hint {
  position: fixed;
  bottom: calc(70px + env(safe-area-inset-bottom, 0px));
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  padding: var(--spacing-sm) var(--spacing-lg);
  border-radius: var(--border-radius-lg);
  font-size: var(--font-size-sm);
  z-index: 100;
}

/* 提示词区域 */
.suggestion-area {
  padding: var(--spacing-lg);
  background-color: rgba(249, 249, 249, 0.95);
  border-bottom: 1px solid var(--border-color);
}

.suggestion-title {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  margin-bottom: var(--spacing-sm);
  font-weight: 500;
}

.suggestion-chips {
  display: flex;
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
  overflow-x: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.suggestion-chips::-webkit-scrollbar {
  display: none;
}

.suggestion-chip {
  background-color: rgb(255, 255, 255);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xs) var(--spacing-md);
  font-size: var(--font-size-sm);
  color: #4b90e2;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
  flex-shrink: 0;
}

.suggestion-chip:active {
  background-color: var(--primary-light);
  color: white;
  border-color: var(--primary-light);
}

.ai-intro {
  background-color: rgba(74, 144, 226, 0.08);
  border-radius: var(--border-radius);
  padding: var(--spacing-md);
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.5;
}

.intro-title {
  color: var(--primary-color);
  font-weight: 600;
}

/* AI思考中动效 */
.thinking {
  display: flex;
  align-items: center;
}

.loading-dots {
  display: flex;
  align-items: center;
  margin-left: var(--spacing-sm);
}

.dot {
  width: 6px;
  height: 6px;
  margin: 0 2px;
  background-color: var(--primary-color);
  border-radius: 50%;
  display: inline-block;
  animation: dot-pulse 1.5s infinite ease-in-out;
}

.dot:nth-child(1) {
  animation-delay: 0s;
}

.dot:nth-child(2) {
  animation-delay: 0.3s;
}

.dot:nth-child(3) {
  animation-delay: 0.6s;
}

@keyframes dot-pulse {
  0% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  50% {
    transform: scale(1.2);
    opacity: 1;
  }
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
}

/* 底部安全区域 - 防止内容被底部遮挡 */
.safe-bottom-area {
  height: calc(80px + env(safe-area-inset-bottom, 0px));
  width: 100%;
  margin-bottom: 20px;
}

/* 响应式样式调整 */
@media screen and (max-width: 375px) {
  .chat-header {
    padding: var(--spacing-sm) var(--spacing-md);
    height: 44px;
  }
  
  .back-btn, .chat-settings {
    width: 32px;
    height: 32px;
  }
  
  .chat-content {
    padding: var(--spacing-md);
  }
  
  .message {
    max-width: 85%;
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: var(--font-size-sm);
  }
  
  .message-avatar {
    width: 32px; /* 在小屏幕上略微减小头像尺寸 */
    height: 32px;
  }
  
  .chat-input-area {
    padding: var(--spacing-sm) var(--spacing-md);
    gap: 8px;
  }
  
  .input-mode-toggle {
    margin-bottom: 4px;
  }
  
  .mode-label {
    font-size: 10px;
  }
  
  .chat-input {
    padding: 8px 10px;
    padding-right: 40px;
    min-height: 38px;
  }
  
  .send-btn-area {
    right: 3px;
    bottom: 1px;
  }
  
  .chat-btn.send-btn {
    width: 34px;
    height: 34px;
  }
  
  .suggestion-chip {
    padding: 3px var(--spacing-sm);
  }
}

.ai-message-text {
  white-space: pre-wrap;
  word-break: break-word;
  font-size: var(--font-size-md);
  line-height: 1.5;
}

/* 图片消息样式 */
.ai-image-container {
  width: 100%;
  position: relative;
  max-height: 70vh; /* 限制最大高度，防止图片过大 */
  overflow-y: auto; /* 允许垂直滚动 */
}

.ai-generated-image {
  width: 100%;
  height: auto;
  border-radius: 8rpx;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.image-hint {
  color: #999;
  font-size: 24rpx;
  text-align: center;
  margin-top: 10rpx;
}

/* 修改消息气泡样式以适应图片 */
.message-ai {
  max-width: 65vw;
  padding: var(--spacing-sm);
}

/* 保持文本消息的原有内边距 */
.message-ai .ai-message-text {
  padding: var(--spacing-sm) var(--spacing-md);
}

/* 模式切换按钮样式 */
.toggle-mode {
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s ease;
}

/* 增加滚动指示器 */
.chat-content::-webkit-scrollbar {
  width: 5px;
}

.chat-content::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 2.5px;
}

/* 改进滚动区域，确保可以滑动查看所有内容 */
.scroll-view-container {
  -webkit-overflow-scrolling: touch; /* 增强iOS滚动体验 */
  overflow-y: scroll;
  height: 100%;
}

/* 响应式调整 */
@media screen and (max-height: 600px) {
  .safe-bottom-area {
    height: 100px; /* 较小屏幕减少底部安全区域 */
  }
  
  .chat-content {
    padding-bottom: 50px; /* 减少底部padding */
  }
}

/* 自定义弹窗样式 */
.custom-alert :deep(.tui-alert-content) {
  max-height: 60vh !important; /* 设置内容区域最大高度 */
  padding: 0 !important; /* 移除内边距，由子元素控制 */
  overflow: hidden !important; /* 隐藏溢出内容 */
}

/* 滚动视图样式 */
.alert-scroll-view {
  max-height: 60vh; /* 与父元素一致 */
  padding: 15px; /* 补充内边距 */
  -webkit-overflow-scrolling: touch; /* 增强iOS滚动体验 */
}

/* 弹窗内容样式 */
.alert-content {
  white-space: pre-wrap; /* 保留换行符 */
  word-break: break-word; /* 单词换行 */
  line-height: 1.5; /* 增加行高 */
  font-size: 14px; /* 设置字体大小 */
  width: 100%; /* 确保宽度充足 */
  display: block; /* 块级显示 */
}

/* 自定义滚动条样式 */
.alert-scroll-view::-webkit-scrollbar {
  width: 4px;
}

.alert-scroll-view::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 2px;
}

/* 附加功能提示区域 */
.function-tip-area {
  padding: 10px 14px;
  background-color: #f5f9ff;
  border-radius: 10px;
  margin-bottom: 12px;
  border-left: 3px solid #4A90E2;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  animation: tip-fade-in 0.3s ease-in-out;
  transition: all 0.3s ease;
}

@keyframes tip-fade-in {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.function-tip-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.function-tip-text {
  font-size: 14px;
  color: #4c5864;
  line-height: 1.5;
  margin-left: 4px;
  flex: 1;
}

/* 不同功能的提示样式 */
.translate-tip {
  background-color: #eef6ff;
  border-left-color: #4A90E2;
  border-left-width: 4px;
}

.review-tip {
  background-color: #fff8ee;
  border-left-color: #FF9500;
  border-left-width: 4px;
}

.other-tip {
  background-color: #f2fbf2;
  border-left-color: #5cb85c;
  border-left-width: 4px;
}

.drawer-container {
  padding: 20px 16px;
  padding-bottom: calc(16px + env(safe-area-inset-bottom, 16px));
  background-color: white;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
  position: relative;
}

.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  position: relative;
}

.drawer-title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  text-align: center;
  width: 100%;
  position: absolute;
  left: 0;
  pointer-events: none;
}

.drawer-close-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f5;
  transition: all 0.2s ease;
  position: relative;
  z-index: 1;
}

.drawer-close-btn:active {
  background-color: #e0e0e0;
  transform: scale(0.95);
}

.drawer-divider {
  height: 1px;
  background-color: #e8e8e8;
  margin-bottom: 20px;
}

.custom-cascade {
  height: 300px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.function-status-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

.function-status-text.active {
  color: #4A90E2;
}

.drawer-handle {
  width: 40px;
  height: 5px;
  background-color: #e0e0e0;
  border-radius: 3px;
  margin: 0 auto 16px;
}
</style>
